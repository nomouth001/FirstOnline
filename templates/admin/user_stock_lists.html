{% extends "base.html" %}

{% block title %}{{ user.username }}ì˜ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ - ê´€ë¦¬ì{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>ğŸ“Š {{ user.username }}ì˜ ì¢…ëª© ë¦¬ìŠ¤íŠ¸</h2>
        <a href="{{ url_for('admin.admin_users') }}" class="btn btn-secondary">â† ì‚¬ìš©ì ëª©ë¡ìœ¼ë¡œ</a>
    </div>
    
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <h4>ì‚¬ìš©ì ì •ë³´</h4>
        <p><strong>ì‚¬ìš©ìëª…:</strong> {{ user.username }}</p>
        <p><strong>ì´ë¦„:</strong> {{ user.get_full_name() }}</p>
        <p><strong>ì´ë©”ì¼:</strong> {{ user.email }}</p>
        <p><strong>ê°€ì…ì¼:</strong> {{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
        <p><strong>ìƒíƒœ:</strong> 
            {% if user.is_active %}
                <span style="color: green;">í™œì„±</span>
            {% else %}
                <span style="color: red;">ë¹„í™œì„±</span>
            {% endif %}
        </p>
    </div>
</div>

<div class="card">
    <h3>ğŸ“‹ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ({{ stock_lists|length }}ê°œ)</h3>
    <form id="bulk-action-form" method="POST">
        <div class="bulk-actions mb-3">
            <button type="button" id="bulk-generate-btn" class="btn btn-primary">ì„ íƒëœ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ ë¶„ì„</button>
            <span id="bulk-status" class="ml-2"></span>
        </div>
        
        <table class="table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-checkbox"></th>
                    <th>ë¦¬ìŠ¤íŠ¸ëª…</th>
                    <th>ì„¤ëª…</th>
                    <th>ì¢…ëª© ìˆ˜</th>
                    <th>ê³µê°œ ì—¬ë¶€</th>
                    <th>ìƒì„±ì¼</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>
                {% for stock_list in stock_lists %}
                <tr>
                    <td><input type="checkbox" class="list-checkbox" name="list_ids" value="{{ stock_list.id }}"></td>
                    <td>
                        <a href="{{ url_for('admin.user_stock_list_detail', user_id=user.id, list_id=stock_list.id) }}">{{ stock_list.name }}</a>
                        {% if stock_list.is_default %}
                            <span style="background: #007bff; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-left: 0.5rem;">ê¸°ë³¸</span>
                        {% endif %}
                    </td>
                    <td>{{ stock_list.description|truncate(50) }}</td>
                    <td>{{ stock_list.stocks|length }}</td>
                    <td>{{ 'ê³µê°œ' if stock_list.is_public else 'ë¹„ê³µê°œ' }}</td>
                    <td>{{ stock_list.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                        <a href="{{ url_for('admin.edit_user_stock_list', user_id=user.id, list_id=stock_list.id) }}" class="btn btn-sm btn-secondary">ìˆ˜ì •</a>
                        <form action="{{ url_for('admin.delete_user_stock_list', user_id=user.id, list_id=stock_list.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('ì •ë§ ì´ ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në¦¬ìŠ¤íŠ¸ëª…: {{ stock_list.name }}\nì¢…ëª© ìˆ˜: {{ stock_list.stocks|length }}ê°œ\n{% if stock_list.is_default %}âš ï¸ ê¸°ë³¸ ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤!{% endif %}');">
                            <button type="submit" class="btn btn-sm btn-danger">ì‚­ì œ</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
</div>

<div class="card">
    <h3>ğŸš€ ë¹ ë¥¸ ì‘ì—…</h3>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        <a href="{{ url_for('admin.admin_users') }}" class="btn btn-secondary">ì‚¬ìš©ì ëª©ë¡</a>
        <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-primary">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</a>
        <button type="button" class="btn btn-warning" onclick="cleanupUserDuplicateLists()">ğŸ§¹ ì¤‘ë³µ ë¦¬ìŠ¤íŠ¸ ì •ë¦¬</button>
        <button type="button" class="btn btn-danger" onclick="deleteAllDefaultLists()">ğŸ—‘ï¸ ëª¨ë“  ê¸°ë³¸ ë¦¬ìŠ¤íŠ¸ ì‚­ì œ</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const listCheckboxes = document.querySelectorAll('.list-checkbox');
    const bulkGenerateBtn = document.getElementById('bulk-generate-btn');
    const bulkStatus = document.getElementById('bulk-status');

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            listCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }

    if (bulkGenerateBtn) {
        bulkGenerateBtn.addEventListener('click', function() {
            const selectedIds = Array.from(listCheckboxes)
                                   .filter(checkbox => checkbox.checked)
                                   .map(checkbox => checkbox.value);

            if (selectedIds.length === 0) {
                alert('ë¶„ì„í•  ë¦¬ìŠ¤íŠ¸ë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!confirm(`ì„ íƒëœ ${selectedIds.length}ê°œì˜ ë¦¬ìŠ¤íŠ¸ì— í¬í•¨ëœ ëª¨ë“  ì¢…ëª©ì˜ ë¶„ì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            this.disabled = true;
            bulkStatus.textContent = 'ë¶„ì„ì„ ìš”ì²­ ì¤‘ì…ë‹ˆë‹¤...';

            fetch("{{ url_for('admin.bulk_generate_for_user_lists', user_id=user.id) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ list_ids: selectedIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bulkStatus.textContent = data.message;
                    alert(data.message);
                } else {
                    bulkStatus.textContent = 'ì˜¤ë¥˜: ' + data.error;
                    alert('ì˜¤ë¥˜: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                bulkStatus.textContent = 'í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                alert('í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            })
            .finally(() => {
                this.disabled = false;
            });
        });
    }
});

// ê´€ë¦¬ì ì „ìš© ê¸°ëŠ¥ë“¤
function cleanupUserDuplicateLists() {
    if (confirm('{{ user.username }}ì˜ ì¤‘ë³µëœ ë¦¬ìŠ¤íŠ¸ë¥¼ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në™ì¼í•œ ì´ë¦„ì˜ ë¦¬ìŠ¤íŠ¸ê°€ ì—¬ëŸ¬ ê°œ ìˆëŠ” ê²½ìš°, ê°€ì¥ ìµœê·¼ ê²ƒë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ëŠ” ì‚­ì œë©ë‹ˆë‹¤.\nì¢…ëª©ì€ ìµœì‹  ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™ë©ë‹ˆë‹¤.')) {
        fetch('{{ url_for("admin.admin_cleanup_user_duplicate_lists", user_id=user.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let message = `ì¤‘ë³µ ë¦¬ìŠ¤íŠ¸ ì •ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì‚­ì œëœ ë¦¬ìŠ¤íŠ¸: ${data.deleted_count}ê°œ`;
                if (data.merged_stocks > 0) {
                    message += `\në³‘í•©ëœ ì¢…ëª©: ${data.merged_stocks}ê°œ`;
                }
                alert(message);
                location.reload();
            } else {
                alert('ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
            }
        })
        .catch(error => {
            alert('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
        });
    }
}

function deleteAllDefaultLists() {
    if (confirm('{{ user.username }}ì˜ ëª¨ë“  ê¸°ë³¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\nì‚¬ìš©ìê°€ ìµœì†Œ 1ê°œì˜ ë¦¬ìŠ¤íŠ¸ëŠ” ë³´ìœ í•˜ë„ë¡ ë³´ì¥ë©ë‹ˆë‹¤.')) {
        fetch('{{ url_for("admin.admin_delete_all_default_lists", user_id=user.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`ê¸°ë³¸ ë¦¬ìŠ¤íŠ¸ ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì‚­ì œëœ ë¦¬ìŠ¤íŠ¸: ${data.deleted_count}ê°œ`);
                location.reload();
            } else {
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
            }
        })
        .catch(error => {
            alert('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
        });
    }
}
</script>
{% endblock %} 