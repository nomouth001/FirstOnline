{% extends "base.html" %}
{% block content %}
<div class="card">
    <h1>âš™ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
    <p>ì‹œìŠ¤í…œ ê´€ë¦¬ ë° ê³ ê¸‰ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
</div>

<h2>ê´€ì‹¬ ì¢…ëª© ë“±ë¡</h2>
<form id="ticker-form">
  <label for="ticker">ì¢…ëª© ì½”ë“œ:</label>
  <input type="text" id="ticker" required>
  <button type="submit">ì¡°íšŒ</button>
</form>

<div id="lookup-result" style="margin-top: 15px;"></div>

<h3 style="margin-top: 30px;">
  ğŸ“‹ í˜„ì¬ í™œì„± ì¢…ëª© ë¦¬ìŠ¤íŠ¸: <span id="current-list-name">Default</span>
</h3>

<div style="margin-bottom: 20px;">
  <label for="stock-list-select">ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì„ íƒ:</label>
  <select id="stock-list-select" onchange="selectStockList()">
  </select>
  <button onclick="document.getElementById('create-list-modal').style.display='block'">ìƒˆ ë¦¬ìŠ¤íŠ¸ ìƒì„±</button>
  <button onclick="deleteStockList()">í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ì‚­ì œ</button>
</div>

<div id="create-list-modal" style="display:none; border: 1px solid #ccc; padding: 20px; margin-top: 20px; background-color: white;">
  <h4>ìƒˆ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ìƒì„±</h4>
  <label for="new-list-name">ë¦¬ìŠ¤íŠ¸ ì´ë¦„:</label>
  <input type="text" id="new-list-name" required>
  <button onclick="createStockList()">ìƒì„±</button>
  <button onclick="document.getElementById('create-list-modal').style.display='none'">ì·¨ì†Œ</button>
</div>

<!-- ì¼ê´„ìƒì„± ë° ìš”ì•½ ì„¹ì…˜ -->
<div style="margin-top: 30px; margin-bottom: 20px; padding: 20px; background-color: #f8f9fa; border: 2px solid #007bff; border-radius: 10px;">
  <h3 style="margin-top: 0; color: #007bff;">ğŸš€ ì¼ê´„ ë¶„ì„ ë° ìš”ì•½</h3>
  
  <!-- íŒŒì¼ ê´€ë¦¬ ì„¹ì…˜ ì¶”ê°€ -->
  <div style="margin-bottom: 20px; padding: 15px; background-color: white; border-radius: 8px; border-left: 4px solid #ffc107;">
    <h4 style="margin-top: 0; color: #856404;">ğŸ“ íŒŒì¼ ê´€ë¦¬</h4>
    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
      <a href="/file-summary" target="_blank" style="padding: 12px 20px; background-color: #ffc107; color: #212529; text-decoration: none; border-radius: 5px; font-size: 16px; font-weight: bold;">
        ğŸ“Š íŒŒì¼ í˜„í™© ë³´ê¸°
      </a>
      <button onclick="cleanupFiles()" style="padding: 12px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer;">
        ğŸ§¹ ì˜¤ë˜ëœ íŒŒì¼ ì •ë¦¬
      </button>
    </div>
  </div>

  <!-- í”„ë¡¬í”„íŠ¸ í…ŒìŠ¤íŠ¸ ì„¹ì…˜ ì¶”ê°€ -->
  <div style="margin-bottom: 20px; padding: 15px; background-color: white; border-radius: 8px; border-left: 4px solid #17a2b8;">
    <h4 style="margin-top: 0; color: #0c5460;">ğŸ§ª í”„ë¡¬í”„íŠ¸ í…ŒìŠ¤íŠ¸</h4>
    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
      <a href="/prompt-test" target="_blank" style="padding: 12px 20px; background-color: #17a2b8; color: white; text-decoration: none; border-radius: 5px; font-size: 16px; font-weight: bold;">
        ğŸ§ª AI í”„ë¡¬í”„íŠ¸ í…ŒìŠ¤íŠ¸ ë„êµ¬
      </a>
    </div>
  </div>

  <!-- í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ìƒì„± -->
  <div style="margin-bottom: 20px; padding: 15px; background-color: white; border-radius: 8px; border-left: 4px solid #28a745;">
    <h4 style="margin-top: 0; color: #28a745;">ğŸ“Š í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ìƒì„±</h4>
    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
      <button id="batch-generate-btn" onclick="generateAllChartsAndAnalysis()" style="padding: 12px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer;">
        ğŸ“Š í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ì „ì²´ ì¢…ëª© ì¼ê´„ìƒì„±
      </button>
      <a href="/summary_page" target="_blank" style="padding: 12px 20px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; font-size: 16px; font-weight: bold;">
        ğŸ“ˆ í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ë¶„ì„ ìš”ì•½ ë³´ê¸°
      </a>
    </div>
    <div id="current-progress-text" style="margin-top: 10px; padding: 15px; background-color: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; display: none; font-size: 14px; color: #1976d2; font-weight: 500;">
      <!-- í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ì§„í–‰ìƒí™©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      <div style="margin-top: 10px;">
        <button id="stop-single-btn" onclick="stopBatchProcessing()" style="padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; display: none;">
          â¹ï¸ ì¼ê´„ìƒì„± ì¤‘ë‹¨
        </button>
      </div>
    </div>
  </div>

  <!-- ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ìƒì„± -->
  <div style="margin-bottom: 20px; padding: 15px; background-color: white; border-radius: 8px; border-left: 4px solid #dc3545;">
    <h4 style="margin-top: 0; color: #dc3545;">ğŸ¯ ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ìƒì„±</h4>
    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
      <button id="multi-batch-generate-btn" onclick="showMultiListSelector()" style="padding: 12px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer;">
        ğŸ¯ ì„ íƒëœ ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ìƒì„±
      </button>
      <button id="multi-summary-btn" onclick="showMultiSummarySelector()" style="padding: 12px 20px; background-color: #6f42c1; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer;">
        ğŸ“Š ì„ íƒëœ ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ë¶„ì„ ìš”ì•½ ë³´ê¸°
      </button>
    </div>
    <div id="multi-progress-text" style="margin-top: 10px; padding: 15px; background-color: #fce4ec; border: 2px solid #e91e63; border-radius: 8px; display: none; font-size: 14px; color: #c2185b; font-weight: 500;">
      <!-- ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì§„í–‰ìƒí™©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      <div style="margin-top: 10px;">
        <button id="stop-multi-btn" onclick="stopBatchProcessing()" style="padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; display: none;">
          â¹ï¸ ì¼ê´„ìƒì„± ì¤‘ë‹¨
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì„ íƒ ëª¨ë‹¬ -->
<div id="multi-list-modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
    <h3 id="modal-title" style="margin-top: 0; color: #007bff;">ë¦¬ìŠ¤íŠ¸ ì„ íƒ</h3>
    <div id="modal-description" style="margin-bottom: 20px; color: #6c757d;">
      ì¼ê´„ìƒì„±í•  ë¦¬ìŠ¤íŠ¸ë“¤ì„ ì„ íƒí•˜ì„¸ìš”.
    </div>
    
    <div id="lists-container" style="margin-bottom: 20px;">
      <!-- ë¦¬ìŠ¤íŠ¸ ì²´í¬ë°•ìŠ¤ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>
    
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="closeMultiListModal()" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">ì·¨ì†Œ</button>
      <button id="modal-confirm-btn" onclick="confirmMultiListAction()" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>
    </div>
  </div>
</div>

<h3>ğŸ“‹ ì¢…ëª© ëª©ë¡</h3>
<table id="ticker-table" border="1">
  <thead>
    <tr>
      <th><button onclick="sortTable(0)">í‹°ì»¤ â‡…</button></th>
      <th><button onclick="sortTable(1)">íšŒì‚¬ â‡…</button></th>
      <th>ì‚­ì œ</th>
      <th>ì°¨íŠ¸ ìƒì„±</th>
      <th>AI ë¶„ì„ ë³´ê¸°</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  let currentSortColumn = -1;
  let currentSortDirection = "asc"; // "asc" for ascending, "desc" for descending

  // ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ê´€ë ¨ ë³€ìˆ˜
  let currentModalAction = null; // 'generate' ë˜ëŠ” 'summary'
  let allStockLists = []; // ëª¨ë“  ë¦¬ìŠ¤íŠ¸ ëª©ë¡

  let progressInterval = null;

  // ì‹¤ì‹œê°„ ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  async function updateProgressDisplay() {
    try {
      console.log('ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ ì‹œì‘...');
      const response = await fetch('/get_current_progress');
      const data = await response.json();
      
      console.log('ì§„í–‰ìƒí™© ë°ì´í„°:', data); // ë””ë²„ê¹…ìš©
      
      const progressText = document.getElementById('current-progress-text');
      const multiProgressText = document.getElementById('multi-progress-text');
      const stopSingleBtn = document.getElementById('stop-single-btn');
      const stopMultiBtn = document.getElementById('stop-multi-btn');
      
      if (!progressText || !multiProgressText) {
        console.error('ì§„í–‰ìƒí™© í‘œì‹œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (data.is_running) {
        console.log('ì§„í–‰ ì¤‘ì¸ ì‘ì—… ë°œê²¬:', data.type);
        
        let displayText = '';
        if (data.type === 'single') {
          displayText = `<strong>ğŸ“Š í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ìƒì„± ì§„í–‰ ì¤‘...</strong><br>`;
          displayText += `â€¢ í˜„ì¬ ì²˜ë¦¬ ì¤‘: <span style="color: #007bff; font-weight: bold;">${data.current_ticker || 'ì¤€ë¹„ ì¤‘'}</span><br>`;
          displayText += `â€¢ ì§„í–‰ë¥ : <span style="color: #28a745; font-weight: bold;">${data.processed_tickers}/${data.total_tickers} (${data.progress_percentage}%)</span><br>`;
          if (data.elapsed_time) {
            displayText += `â€¢ ê²½ê³¼ ì‹œê°„: <span style="color: #6c757d;">${data.elapsed_time}</span><br>`;
          }
          if (data.estimated_completion) {
            displayText += `â€¢ ì˜ˆìƒ ì™„ë£Œ: <span style="color: #dc3545;">${data.estimated_completion}</span>`;
          }
          
          progressText.innerHTML = displayText + '<div style="margin-top: 10px;"><button id="stop-single-btn" onclick="stopBatchProcessing()" style="padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer;">â¹ï¸ ì¼ê´„ìƒì„± ì¤‘ë‹¨</button></div>';
          progressText.style.display = 'block';
          multiProgressText.style.display = 'none';
          console.log('ë‹¨ì¼ ë¦¬ìŠ¤íŠ¸ ì§„í–‰ìƒí™© í‘œì‹œë¨');
        } else if (data.type === 'multiple') {
          displayText = `<strong>ğŸ¯ ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ìƒì„± ì§„í–‰ ì¤‘...</strong><br>`;
          displayText += `â€¢ í˜„ì¬ ì²˜ë¦¬ ì¤‘: <span style="color: #007bff; font-weight: bold;">${data.current_ticker || 'ì¤€ë¹„ ì¤‘'}</span> (${data.current_list || ''})<br>`;
          displayText += `â€¢ ì§„í–‰ë¥ : <span style="color: #28a745; font-weight: bold;">${data.processed_tickers}/${data.total_tickers} (${data.progress_percentage}%)</span><br>`;
          if (data.elapsed_time) {
            displayText += `â€¢ ê²½ê³¼ ì‹œê°„: <span style="color: #6c757d;">${data.elapsed_time}</span><br>`;
          }
          if (data.estimated_completion) {
            displayText += `â€¢ ì˜ˆìƒ ì™„ë£Œ: <span style="color: #dc3545;">${data.estimated_completion}</span>`;
          }
          
          multiProgressText.innerHTML = displayText + '<div style="margin-top: 10px;"><button id="stop-multi-btn" onclick="stopBatchProcessing()" style="padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer;">â¹ï¸ ì¼ê´„ìƒì„± ì¤‘ë‹¨</button></div>';
          multiProgressText.style.display = 'block';
          progressText.style.display = 'none';
          console.log('ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì§„í–‰ìƒí™© í‘œì‹œë¨');
        }
      } else {
        console.log('ì§„í–‰ ì¤‘ì¸ ì‘ì—… ì—†ìŒ - ì§„í–‰ìƒí™© í‘œì‹œ ìˆ¨ê¹€');
        // ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì´ ì—†ìœ¼ë©´ ì§„í–‰ìƒí™© í‘œì‹œ ìˆ¨ê¸°ê¸°
        progressText.style.display = 'none';
        multiProgressText.style.display = 'none';
        
        // ì¸í„°ë²Œ ì •ì§€
        stopProgressMonitoring();
      }
    } catch (error) {
      console.error('ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
      // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì§„í–‰ìƒí™© í‘œì‹œ ì˜ì—­ì„ ìˆ¨ê¹€
      const progressText = document.getElementById('current-progress-text');
      const multiProgressText = document.getElementById('multi-progress-text');
      if (progressText) progressText.style.display = 'none';
      if (multiProgressText) multiProgressText.style.display = 'none';
    }
  }

  // ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì‹œì‘
  function startProgressMonitoring() {
    console.log('ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì‹œì‘ ìš”ì²­ë¨');
    
    // ê¸°ì¡´ ì¸í„°ë²Œì´ ìˆìœ¼ë©´ ì •ë¦¬
    stopProgressMonitoring();
    
    // ìƒˆ ì¸í„°ë²Œ ì‹œì‘
    progressInterval = setInterval(updateProgressDisplay, 2000); // 2ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
    updateProgressDisplay(); // ì¦‰ì‹œ ì²« ë²ˆì§¸ ì—…ë°ì´íŠ¸
    
    console.log('ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì‹œì‘ë¨ - ì¸í„°ë²Œ ID:', progressInterval);
  }

  // ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì •ì§€
  function stopProgressMonitoring() {
    if (progressInterval) {
      console.log('ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì •ì§€ ìš”ì²­ë¨ - ì¸í„°ë²Œ ID:', progressInterval);
      clearInterval(progressInterval);
      progressInterval = null;
      console.log('ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì •ì§€ë¨');
    } else {
      console.log('ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ì´ ì´ë¯¸ ì •ì§€ëœ ìƒíƒœ');
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì‹œì‘
  document.addEventListener('DOMContentLoaded', function() {
    console.log('ì¸ë±ìŠ¤ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - ì§„í–‰ìƒí™© í™•ì¸ ì‹œì‘');
    // ì¦‰ì‹œ ì§„í–‰ìƒí™© í™•ì¸í•˜ì—¬ ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì´ ìˆìœ¼ë©´ ëª¨ë‹ˆí„°ë§ ì‹œì‘
    updateProgressDisplay().then(() => {
      // ì²« ë²ˆì§¸ í™•ì¸ í›„ ì •ê¸°ì ì¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘
      if (!progressInterval) {
        startProgressMonitoring();
      }
    });
  });

  async function loadStockLists() {
    try {
      const res = await fetch('/get_stock_lists');
      const lists = await res.json();
      const select = document.getElementById('stock-list-select');
      select.innerHTML = '';
      lists.forEach(listName => {
        const option = document.createElement('option');
        option.value = listName;
        option.textContent = listName;
        select.appendChild(option);
      });

      // Set current selected list
      const currentListRes = await fetch('/get_current_stock_list');
      const currentListData = await currentListRes.json();
      select.value = currentListData.current_list;
      document.getElementById('current-list-name').textContent = currentListData.current_list;

      loadTickers(); // Load tickers for the initially selected list
    } catch (error) {
      console.error("ì¢…ëª© ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì˜¤ë¥˜ ë°œìƒ: " + error.message);
      console.error("Load stock lists error:", error);
    }
  }

  async function selectStockList() {
    const select = document.getElementById('stock-list-select');
    const selectedListName = select.value;
    try {
      const res = await fetch('/select_stock_list', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ list_name: selectedListName })
      });
      const message = await res.text();
      showInlineMessage(message, res.ok ? 'success' : 'error');
      if (res.ok) {
        document.getElementById('current-list-name').textContent = selectedListName;
        loadTickers(); // Reload tickers for the newly selected list
      }
    } catch (error) {
      showInlineMessage("ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì„ íƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message, 'error');
      console.error("Select stock list error:", error);
    }
  }

  async function createStockList() {
    const newListName = document.getElementById('new-list-name').value.trim();
    if (!newListName) {
      showInlineMessage("ìƒˆ ë¦¬ìŠ¤íŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì‹­ì‹œì˜¤.", 'error');
      return;
    }

    try {
      const res = await fetch('/create_stock_list', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ list_name: newListName })
      });
      const message = await res.text();
      showInlineMessage(message, res.ok ? 'success' : 'error');
      if (res.ok) {
        document.getElementById('new-list-name').value = '';
        document.getElementById('create-list-modal').style.display = 'none';
        await loadStockLists(); // Reload lists to show the new one
        // The new list is automatically selected by the backend
      }
    } catch (error) {
      showInlineMessage("ìƒˆ ë¦¬ìŠ¤íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
      console.error("Create stock list error:", error);
    }
  }

  async function deleteStockList() {
    const select = document.getElementById('stock-list-select');
    const selectedListName = select.value;

    if (selectedListName === 'default') {
      showInlineMessage("ê¸°ë³¸ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'error');
      return;
    }

    if (!confirm(`ì •ë§ë¡œ '${selectedListName}' ì¢…ëª© ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ë¦¬ìŠ¤íŠ¸ì— í¬í•¨ëœ ëª¨ë“  ì¢…ëª©ì´ ì‚­ì œë©ë‹ˆë‹¤.`)) {
      return;
    }

    try {
      const res = await fetch(`/delete_stock_list?list_name=${selectedListName}`, {
        method: 'DELETE'
      });
      const message = await res.text();
      showInlineMessage(message, 'success');
      if (res.ok) {
        await loadStockLists(); // Reload lists and update current list
      }
    } catch (error) {
      showInlineMessage("ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message, 'error');
      console.error("Delete stock list error:", error);
    }
  }

  async function loadTickers() {
    try {
        const res = await fetch('/get_tickers');
        const tickers = await res.json();
        const tbody = document.querySelector('#ticker-table tbody');
        tbody.innerHTML = '';

        if (tickers.error) {
            showInlineMessage("ê´€ì‹¬ ì¢…ëª©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + tickers.error, 'error');
            return;
        }

        // Sort tickers before rendering if a sort was applied
        if (currentSortColumn !== -1) {
            tickers.sort((a, b) => {
                let valA, valB;
                if (currentSortColumn === 0) { // Ticker column
                    valA = a.ticker.toUpperCase();
                    valB = b.ticker.toUpperCase();
                } else if (currentSortColumn === 1) { // Company name column
                    valA = a.name.toUpperCase();
                    valB = b.name.toUpperCase();
                }

                if (valA < valB) return currentSortDirection === "asc" ? -1 : 1;
                if (valA > valB) return currentSortDirection === "asc" ? 1 : -1;
                return 0;
            });
        }

        tickers.forEach(row => {
          const ticker = row.ticker.toUpperCase();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${ticker}</td>
            <td>${row.name}</td>
            <td><button onclick="deleteTicker('${ticker}')">ì‚­ì œ</button></td>
            <td><button onclick="generateChart('${ticker}')">ì°¨íŠ¸ ìƒì„±</button></td>
            <td><button onclick="viewChartAnalysis('${ticker}')">ì°¨íŠ¸ ë¶„ì„ ë³´ê¸°</button></td>
          `;
          tbody.appendChild(tr);
        });
    } catch (error) {
        showInlineMessage("ê´€ì‹¬ ì¢…ëª© ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message, 'error');
        console.error("Load tickers error:", error);
    }
  }

  function sortTable(column) {
    if (currentSortColumn === column) {
      currentSortDirection = currentSortDirection === "asc" ? "desc" : "asc";
    } else {
      currentSortColumn = column;
      currentSortDirection = "asc";
    }
    loadTickers(); // Reload tickers with the new sort order
  }

  document.getElementById("ticker-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const ticker = document.getElementById("ticker").value.toUpperCase();
    const lookupResultDiv = document.getElementById("lookup-result");
    lookupResultDiv.innerHTML = `<p>ì¡°íšŒ ì¤‘...</p>`;

    try {
        const res = await fetch(`/lookup?ticker=${ticker}`);
        if (!res.ok) {
            const errorText = await res.text();
            lookupResultDiv.innerHTML = `<p>ì¡°íšŒ ì‹¤íŒ¨: ${errorText}</p>`;
            return;
        }
        const data = await res.json();
        if (data.name) {
            lookupResultDiv.innerHTML = `
                <p>${data.name} (${ticker})</p>
                <button onclick="addTicker('${ticker}', '${data.name}')">ë“±ë¡</button>`;
        } else {
            lookupResultDiv.innerHTML = `<p>ì˜ëª»ëœ ì½”ë“œì´ê±°ë‚˜ ì¢…ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
        }
    } catch (error) {
        lookupResultDiv.innerHTML = `<p>ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`;
        console.error("Lookup error:", error);
    }
  });

  async function addTicker(ticker, name) {
    try {
        const res = await fetch('/add_ticker', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ticker, name })
        });
        const message = await res.text();
        showInlineMessage(message, res.ok ? 'success' : 'error');
        if (res.ok) {
            loadTickers();
            document.getElementById("lookup-result").innerHTML = '';
            document.getElementById("ticker").value = '';
        }
    } catch (error) {
        showInlineMessage("ì¢…ëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message, 'error');
        console.error("Add ticker error:", error);
    }
  }

  async function deleteTicker(ticker) {
    if (!confirm(`ì •ë§ë¡œ ${ticker} ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    try {
        const res = await fetch(`/delete_ticker?ticker=${ticker}`, { method: 'DELETE' });
        const message = await res.text();
        showInlineMessage(message, 'success');
        if (res.ok) {
            loadTickers();
        }
    } catch (error) {
        showInlineMessage("ì¢…ëª© ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message, 'error');
        console.error("Delete ticker error:", error);
    }
  }

  // ì¸ë¼ì¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
  function showInlineMessage(message, type) {
    // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
    const existingMessage = document.getElementById('inline-message');
    if (existingMessage) {
      existingMessage.remove();
    }

    // ìƒˆ ë©”ì‹œì§€ ìƒì„±
    const messageDiv = document.createElement('div');
    messageDiv.id = 'inline-message';
    messageDiv.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      max-width: 400px;
      word-wrap: break-word;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease-out;
    `;
    
    if (type === 'success') {
      messageDiv.style.backgroundColor = '#28a745';
    } else if (type === 'warning') {
      messageDiv.style.backgroundColor = '#ffc107';
      messageDiv.style.color = '#212529';
    } else if (type === 'info') {
      messageDiv.style.backgroundColor = '#17a2b8';
    } else {
      messageDiv.style.backgroundColor = '#dc3545';
    }
    
    // HTML ì½˜í…ì¸ ë¥¼ í¬í•¨í•  ìˆ˜ ìˆë„ë¡ innerHTML ì‚¬ìš©
    if (message.includes('<') && message.includes('>')) {
      messageDiv.innerHTML = message;
    } else {
      messageDiv.textContent = message;
    }
    
    // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(messageDiv);
    
    // 3ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
      if (messageDiv.parentNode) {
        messageDiv.style.animation = 'slideOut 0.3s ease-in';
        messageDiv.style.transform = 'translateX(100%)';
        messageDiv.style.opacity = '0';
        setTimeout(() => {
          if (messageDiv.parentNode) {
            messageDiv.remove();
          }
        }, 300);
      }
    }, 3000);
  }

  async function generateChart(ticker) {
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'ìƒì„± ì¤‘...';
    button.disabled = true;

    try {
        const res = await fetch(`/generate_chart/${ticker}`);
        if (res.ok) {
            const result = await res.json();
            showInlineMessage(`âœ… ${ticker} ì°¨íŠ¸ ìƒì„± ì™„ë£Œ!`, 'success');
        } else {
            const errorData = await res.json();
            showInlineMessage(`âŒ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨: ${errorData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
        }
    } catch (error) {
        showInlineMessage(`ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
        console.error("Generate chart error:", error);
    } finally {
        button.textContent = originalText;
        button.disabled = false;
    }
  }

  async function viewChartAnalysis(ticker) {
    try {
        // ë¨¼ì € ê¸°ì¡´ íŒŒì¼ í™•ì¸
        const checkResponse = await fetch(`/check_existing_analysis/${ticker}`);
        const checkData = await checkResponse.json();
        
        if (checkData.exists) {
            // ê¸°ì¡´ íŒŒì¼ì´ ìˆìœ¼ë©´ í™•ì¸ ì°½ ë„ìš°ê¸°
            const userChoice = confirm(`${checkData.message}\n\n"í™•ì¸"ì„ ëˆ„ë¥´ë©´ ìƒˆë¡œ ìƒì„±í•˜ê³ , "ì·¨ì†Œ"ë¥¼ ëˆ„ë¥´ë©´ ê¸°ì¡´ íŒŒì¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.`);
            
            if (userChoice) {
                // ì‚¬ìš©ìê°€ ìƒˆë¡œ ìƒì„±í•˜ê¸°ë¥¼ ì„ íƒí•œ ê²½ìš° - ì§ì ‘ ìƒˆ ì°½ì—ì„œ ë¶„ì„ í˜ì´ì§€ ì—´ê¸°
                showInlineMessage(`ğŸ”„ ${ticker} ìƒˆë¡œìš´ ë¶„ì„ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`, 'info');
                const newWindow = window.open(`/force_new_analysis_with_timestamp/${ticker}`, '_blank');
                
                // ì´ˆê¸° íŒì—… ì°¨ë‹¨ í™•ì¸ (ì¦‰ì‹œ)
                if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                    // íŒì—…ì´ ì°¨ë‹¨ëœ ê²½ìš° ë§í¬ ì œê³µ
                    const linkHtml = `<a href="/force_new_analysis_with_timestamp/${ticker}" target="_blank" style="color: #007bff; text-decoration: underline;">ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì—¬ ë¶„ì„ í˜ì´ì§€ë¥¼ ì—¬ì„¸ìš”</a>`;
                    showInlineMessage(`âš ï¸ íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ${linkHtml} ë˜ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.`, 'warning');
                } else {
                    // íŒì—…ì´ ì—´ë¦° ê²½ìš°, 5ì´ˆ í›„ì— ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸ (ë¶„ì„ ë¡œë”© ì‹œê°„ ê³ ë ¤)
                    setTimeout(() => {
                        try {
                            if (newWindow.closed) {
                                showInlineMessage(`âŒ ë¶„ì„ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`, 'warning');
                            } else {
                                showInlineMessage(`âœ… ${ticker} ìƒˆë¡œìš´ ë¶„ì„ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.`, 'success');
                            }
                        } catch (e) {
                            // êµì°¨ ì¶œì²˜ ë¬¸ì œë¡œ ì ‘ê·¼í•  ìˆ˜ ì—†ëŠ” ê²½ìš°ëŠ” ì •ìƒì ìœ¼ë¡œ ì—´ë¦° ê²ƒìœ¼ë¡œ ê°„ì£¼
                            showInlineMessage(`âœ… ${ticker} ìƒˆë¡œìš´ ë¶„ì„ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.`, 'success');
                        }
                    }, 5000);
                }
            } else {
                // ì‚¬ìš©ìê°€ ê¸°ì¡´ íŒŒì¼ì„ ì‚¬ìš©í•˜ê¸°ë¥¼ ì„ íƒí•œ ê²½ìš°
                const newWindow = window.open(`/view_chart/${ticker}`, '_blank');
                
                // ì•½ê°„ì˜ ì§€ì—° í›„ íŒì—… ì°¨ë‹¨ í™•ì¸
                setTimeout(() => {
                    if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                        // íŒì—…ì´ ì°¨ë‹¨ëœ ê²½ìš° ë§í¬ ì œê³µ
                        const linkHtml = `<a href="/view_chart/${ticker}" target="_blank" style="color: #007bff; text-decoration: underline;">ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì—¬ ë¶„ì„ í˜ì´ì§€ë¥¼ ì—¬ì„¸ìš”</a>`;
                        showInlineMessage(`âš ï¸ íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ${linkHtml} ë˜ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.`, 'warning');
                    }
                }, 100);
            }
        } else {
            // ê¸°ì¡´ íŒŒì¼ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ë¶„ì„ ì§„í–‰
            const newWindow = window.open(`/view_chart/${ticker}`, '_blank');
            
            // ì•½ê°„ì˜ ì§€ì—° í›„ íŒì—… ì°¨ë‹¨ í™•ì¸
            setTimeout(() => {
                if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                    // íŒì—…ì´ ì°¨ë‹¨ëœ ê²½ìš° ë§í¬ ì œê³µ
                    const linkHtml = `<a href="/view_chart/${ticker}" target="_blank" style="color: #007bff; text-decoration: underline;">ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì—¬ ë¶„ì„ í˜ì´ì§€ë¥¼ ì—¬ì„¸ìš”</a>`;
                    showInlineMessage(`âš ï¸ íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ${linkHtml} ë˜ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.`, 'warning');
                }
            }, 100);
        }
    } catch (error) {
        showInlineMessage(`ì°¨íŠ¸ ë¶„ì„ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
        console.error("View chart analysis error:", error);
    }
  }

  async function generateAllChartsAndAnalysis() {
    const select = document.getElementById('stock-list-select');
    const selectedListName = select.value;
    
    if (!selectedListName) {
      showInlineMessage("ë¦¬ìŠ¤íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", 'error');
      return;
    }
    
    const button = document.getElementById('batch-generate-btn');
    const originalText = button.textContent;
    
    button.textContent = 'ì²˜ë¦¬ ì¤‘...';
    button.disabled = true;
    
    // ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì‹œì‘
    startProgressMonitoring();
    
    try {
      const response = await fetch(`/generate_all_charts_and_analysis/${selectedListName}`);
      const result = await response.json();
      
      if (response.ok) {
        const summary = result.summary;
        if (summary.stopped) {
          showInlineMessage(`â¹ï¸ ì¼ê´„ ì²˜ë¦¬ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ“Š ì²˜ë¦¬ ê²°ê³¼:\nâ€¢ ì´ ì¢…ëª© ìˆ˜: ${summary.total_tickers}ê°œ\nâ€¢ ì²˜ë¦¬ëœ ì¢…ëª©: ${summary.processed}ê°œ\nâ€¢ ì¤‘ë‹¨ë¨: ì‚¬ìš©ì ìš”ì²­`, 'error');
        } else {
          showInlineMessage(`âœ… ì¼ê´„ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ“Š ì²˜ë¦¬ ê²°ê³¼:\nâ€¢ ì´ ì¢…ëª© ìˆ˜: ${summary.total_tickers}ê°œ\nâ€¢ ì„±ê³µ: ${summary.successful}ê°œ\nâ€¢ ì‹¤íŒ¨: ${summary.failed}ê°œ\nâ€¢ ì„±ê³µë¥ : ${summary.success_rate}\n\nğŸ“ˆ ì „ì²´ ì¢…ëª© ë¶„ì„ ìš”ì•½ì„ í™•ì¸í•˜ë ¤ë©´ "í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ë¶„ì„ ìš”ì•½ ë³´ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.`, 'success');
        }
      } else {
        showInlineMessage(`âŒ ì¼ê´„ ì²˜ë¦¬ ì‹¤íŒ¨: ${result.error}`, 'error');
      }
    } catch (error) {
      showInlineMessage(`âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
      console.error("Generate all charts and analysis error:", error);
    } finally {
      button.textContent = originalText;
      button.disabled = false;
    }
  }

  async function showMultiListSelector() {
    currentModalAction = 'generate';
    document.getElementById('modal-title').textContent = 'ğŸ¯ ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ìƒì„±';
    document.getElementById('modal-description').textContent = 'ì¼ê´„ìƒì„±í•  ë¦¬ìŠ¤íŠ¸ë“¤ì„ ì„ íƒí•˜ì„¸ìš”. (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)';
    document.getElementById('modal-confirm-btn').textContent = 'ì¼ê´„ìƒì„± ì‹œì‘';
    document.getElementById('modal-confirm-btn').style.backgroundColor = '#dc3545';
    
    await loadAllStockLists();
    showMultiListModal();
  }

  async function showMultiSummarySelector() {
    currentModalAction = 'summary';
    document.getElementById('modal-title').textContent = 'ğŸ“Š ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ë¶„ì„ ìš”ì•½';
    document.getElementById('modal-description').textContent = 'ë¶„ì„ ìš”ì•½ì„ ë³¼ ë¦¬ìŠ¤íŠ¸ë“¤ì„ ì„ íƒí•˜ì„¸ìš”. (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)';
    document.getElementById('modal-confirm-btn').textContent = 'ìš”ì•½ ë³´ê¸°';
    document.getElementById('modal-confirm-btn').style.backgroundColor = '#6f42c1';
    
    await loadAllStockLists();
    showMultiListModal();
  }

  async function loadAllStockLists() {
    try {
      const res = await fetch('/get_stock_lists');
      allStockLists = await res.json();
      
      const container = document.getElementById('lists-container');
      container.innerHTML = '';
      
      allStockLists.forEach(listName => {
        const div = document.createElement('div');
        div.style.marginBottom = '10px';
        div.innerHTML = `
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" value="${listName}" style="margin-right: 10px;">
            <span style="font-weight: bold;">${listName}</span>
          </label>
        `;
        container.appendChild(div);
      });
    } catch (error) {
      console.error("Error loading stock lists:", error);
      showInlineMessage("ë¦¬ìŠ¤íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", 'error');
    }
  }

  function showMultiListModal() {
    document.getElementById('multi-list-modal').style.display = 'block';
  }

  function closeMultiListModal() {
    document.getElementById('multi-list-modal').style.display = 'none';
    // ëª¨ë“  ì²´í¬ë°•ìŠ¤ í•´ì œ
    const checkboxes = document.querySelectorAll('#lists-container input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
  }

  async function confirmMultiListAction() {
    const selectedLists = [];
    const checkboxes = document.querySelectorAll('#lists-container input[type="checkbox"]:checked');
    
    checkboxes.forEach(cb => {
      selectedLists.push(cb.value);
    });
    
    if (selectedLists.length === 0) {
      showInlineMessage('ìµœì†Œ í•˜ë‚˜ì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
      return;
    }
    
    closeMultiListModal();
    
    if (currentModalAction === 'generate') {
      await generateMultipleListsAnalysis(selectedLists);
    } else if (currentModalAction === 'summary') {
      await showMultipleListsSummary(selectedLists);
    }
  }

  async function generateMultipleListsAnalysis(selectedLists) {
    if (!selectedLists || selectedLists.length === 0) {
      showInlineMessage("ë¦¬ìŠ¤íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", 'error');
      return;
    }
    
    const button = document.getElementById('multi-batch-generate-btn');
    const originalText = button.textContent;
    
    button.textContent = 'ì²˜ë¦¬ ì¤‘...';
    button.disabled = true;
    
    // ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì‹œì‘
    startProgressMonitoring();
    
    try {
      const response = await fetch('/generate_multiple_lists_analysis', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          selected_lists: selectedLists
        })
      });
      
      const result = await response.json();
      
      if (response.ok) {
        const summary = result.summary;
        if (summary.stopped) {
          showInlineMessage(`â¹ï¸ ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ ì²˜ë¦¬ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ“Š ì²˜ë¦¬ ê²°ê³¼:\nâ€¢ ì²˜ë¦¬ëœ ë¦¬ìŠ¤íŠ¸: ${summary.total_lists}ê°œ\nâ€¢ ì´ ì¢…ëª© ìˆ˜: ${summary.total_tickers}ê°œ\nâ€¢ ì²˜ë¦¬ëœ ì¢…ëª©: ${summary.processed}ê°œ\nâ€¢ ì¤‘ë‹¨ë¨: ì‚¬ìš©ì ìš”ì²­`);
        } else {
          showInlineMessage(`âœ… ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ“Š ì²˜ë¦¬ ê²°ê³¼:\nâ€¢ ì²˜ë¦¬ëœ ë¦¬ìŠ¤íŠ¸: ${summary.total_lists}ê°œ\nâ€¢ ì´ ì¢…ëª© ìˆ˜: ${summary.total_tickers}ê°œ\nâ€¢ ì„±ê³µ: ${summary.successful}ê°œ\nâ€¢ ì‹¤íŒ¨: ${summary.failed}ê°œ\nâ€¢ ì„±ê³µë¥ : ${summary.success_rate}\n\nğŸ“ˆ ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ë¶„ì„ ìš”ì•½ì„ í™•ì¸í•˜ë ¤ë©´ "ì„ íƒëœ ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ë¶„ì„ ìš”ì•½ ë³´ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.`);
        }
      } else {
        showInlineMessage(`âŒ ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ ì²˜ë¦¬ ì‹¤íŒ¨: ${result.error}`);
      }
    } catch (error) {
      showInlineMessage(`âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
      console.error("Generate multiple lists analysis error:", error);
    } finally {
      button.textContent = originalText;
      button.disabled = false;
    }
  }

  async function showMultipleListsSummary(selectedLists) {
    const button = document.getElementById('multi-summary-btn');
    const originalText = button.textContent;
    button.textContent = 'ìš”ì•½ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    button.disabled = true;

    console.log('Selected lists for summary:', selectedLists); // ë””ë²„ê¹…ìš©

    try {
      const res = await fetch('/get_multiple_lists_summaries', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ selected_lists: selectedLists })
      });
      const result = await res.json();
      
      console.log('Response from server:', result); // ë””ë²„ê¹…ìš©
      
      if (res.ok) {
        // íŒŒì¼ IDë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆ ì°½ì—ì„œ ìš”ì•½ í˜ì´ì§€ ì—´ê¸°
        const fileId = result.file_id;
        console.log('Opening summary page with file ID:', fileId); // ë””ë²„ê¹…ìš©
        window.open(`/multi_summary_page?file_id=${fileId}`, '_blank');
      } else {
        showInlineMessage(`ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ìš”ì•½ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${result.error}`, 'error');
        console.error("Multiple lists summary error:", result);
      }
    } catch (error) {
      showInlineMessage("ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ìš”ì•½ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: " + error.message, 'error');
      console.error("Show multiple lists summary error:", error);
    } finally {
      button.textContent = originalText;
      button.disabled = false;
    }
  }

  async function cleanupFiles() {
    if (!confirm('30ì¼ ì´ì „ íŒŒì¼ë“¤ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
      return;
    }
    
    try {
      const response = await fetch('/cleanup-files', {
        method: 'POST'
      });
      const result = await response.json();
      
      if (response.ok) {
        showInlineMessage('âœ… íŒŒì¼ ì •ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
      } else {
        showInlineMessage(`âŒ íŒŒì¼ ì •ë¦¬ ì‹¤íŒ¨: ${result.error}`, 'error');
      }
    } catch (error) {
      showInlineMessage(`âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
      console.error("Cleanup files error:", error);
    }
  }

  // ì¼ê´„ ì²˜ë¦¬ ì¤‘ë‹¨ í•¨ìˆ˜
  async function stopBatchProcessing() {
    if (!confirm('ì •ë§ë¡œ ì¼ê´„ ìƒì„±ì„ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ì¢…ëª©ì´ ì™„ë£Œë˜ë©´ ì¤‘ë‹¨ë©ë‹ˆë‹¤.')) {
      return;
    }
    
    try {
      console.log('ì¼ê´„ ì²˜ë¦¬ ì¤‘ë‹¨ ìš”ì²­ ì „ì†¡...');
      const response = await fetch('/stop_batch_processing', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      const result = await response.json();
      
      if (response.ok) {
        showInlineMessage('ì¼ê´„ ì²˜ë¦¬ ì¤‘ë‹¨ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.\ní˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ì¢…ëª©ì´ ì™„ë£Œë˜ë©´ ì¤‘ë‹¨ë©ë‹ˆë‹¤.', 'success');
        console.log('ì¤‘ë‹¨ ìš”ì²­ ì„±ê³µ:', result.message);
      } else {
        showInlineMessage(`ì¤‘ë‹¨ ìš”ì²­ ì‹¤íŒ¨: ${result.error}`, 'error');
        console.error('ì¤‘ë‹¨ ìš”ì²­ ì‹¤íŒ¨:', result);
      }
    } catch (error) {
      showInlineMessage(`ì¤‘ë‹¨ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
      console.error('ì¤‘ë‹¨ ìš”ì²­ ì˜¤ë¥˜:', error);
    }
  }

  loadStockLists(); // Initial load of stock lists and tickers
</script>
{% endblock %}