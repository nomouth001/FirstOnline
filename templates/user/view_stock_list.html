{% extends "base.html" %}

{% block title %}{{ stock_list.name }} - ì¢…ëª© ë¦¬ìŠ¤íŠ¸{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>ğŸ“Š {{ stock_list.name }}</h2>
        <a href="{{ url_for('user_stock.stock_lists') }}" class="btn btn-secondary">â† ë¦¬ìŠ¤íŠ¸ ëª©ë¡ìœ¼ë¡œ</a>
    </div>
    
    {% if stock_list.description %}
        <p style="color: #666; margin-bottom: 1rem;">{{ stock_list.description }}</p>
    {% endif %}
    
    <div style="background: #f8f9fa; padding: 0.5rem 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <p style="margin: 0.25rem 0;"><strong>ì¢…ëª© ìˆ˜:</strong> {{ stocks|length }}ê°œ</p>
        <p style="margin: 0.25rem 0;"><strong>ìƒì„±ì¼:</strong> {{ stock_list.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
        {% if stock_list.is_public %}
            <p style="margin: 0.25rem 0;"><strong>ìƒíƒœ:</strong> <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">ê³µê°œ</span></p>
        {% endif %}
    </div>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>ğŸ“ˆ ì¢…ëª© ëª©ë¡ ({{ stocks|length }}ê°œ)</h3>
        <div style="display: flex; gap: 0.5rem;">
            <a href="{{ url_for('user_stock.add_stock', list_id=stock_list.id) }}" class="btn btn-success">ì¢…ëª© ì¶”ê°€</a>
            {% if stocks %}
                <form method="POST" action="{{ url_for('user_stock.bulk_generate', list_id=stock_list.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-primary" 
                            onclick="return confirm('ì´ ë¦¬ìŠ¤íŠ¸ì˜ ëª¨ë“  ì¢…ëª©ì— ëŒ€í•´ ì¼ê´„ ìƒì„±ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                        ì¼ê´„ ìƒì„±
                    </button>
                </form>
            {% endif %}
        </div>
    </div>
    
    {% if stocks %}
        <div style="overflow-x: auto;">
            <table id="stockTable" style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6; cursor: pointer; user-select: none;" 
                            onclick="sortTable(0, 'text')" data-sort="none">
                            ì¢…ëª© ì½”ë“œ <span class="sort-indicator"></span>
                        </th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6; cursor: pointer; user-select: none;" 
                            onclick="sortTable(1, 'text')" data-sort="none">
                            ì¢…ëª©ëª… <span class="sort-indicator"></span>
                        </th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6; cursor: pointer; user-select: none;" 
                            onclick="sortTable(2, 'date')" data-sort="none">
                            ì¶”ê°€ì¼ <span class="sort-indicator"></span>
                        </th>
                        <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid #dee2e6; cursor: pointer; user-select: none;" 
                            onclick="sortTable(3, 'date')" data-sort="none">
                            ì°¨íŠ¸ ìƒì„± ì‹œê°„ <span class="sort-indicator"></span>
                        </th>
                        <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid #dee2e6; cursor: pointer; user-select: none;" 
                            onclick="sortTable(4, 'date')" data-sort="none">
                            ë¶„ì„ ìƒì„± ì‹œê°„ <span class="sort-indicator"></span>
                        </th>
                        <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid #dee2e6;">ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock_data in stocks_with_status %}
                        {% set stock = stock_data.stock %}
                        {% set file_status = stock_data.file_status %}
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 0.75rem;">
                                <strong>{{ stock.ticker }}</strong>
                                {% if file_status.is_us_stock %}
                                    <span style="background: #007bff; color: white; padding: 2px 4px; border-radius: 3px; font-size: 0.7rem; margin-left: 5px;">US</span>
                                {% else %}
                                    <span style="background: #28a745; color: white; padding: 2px 4px; border-radius: 3px; font-size: 0.7rem; margin-left: 5px;">KR</span>
                                {% endif %}
                            </td>
                            <td style="padding: 0.75rem;">
                                {{ stock.name or stock.ticker }}
                            </td>
                            <td style="padding: 0.75rem; color: #666; font-size: 0.9rem;">
                                {{ stock.created_at.strftime('%Y-%m-%d %H:%M') if stock.created_at else 'N/A' }}
                            </td>
                            <td style="padding: 0.75rem; text-align: center; font-size: 0.9rem;" id="chart-time-{{ stock.ticker }}">
                                {% if file_status.chart.exists %}
                                    <span style="color: #28a745;">{{ file_status.chart.formatted_time }}</span>
                                {% else %}
                                    <span style="color: #6c757d;">ìƒì„± ì•ˆë¨</span>
                                {% endif %}
                            </td>
                            <td style="padding: 0.75rem; text-align: center; font-size: 0.9rem;" id="analysis-time-{{ stock.ticker }}">
                                {% if file_status.analysis.exists %}
                                    <span style="color: #28a745;">{{ file_status.analysis.formatted_time }}</span>
                                {% else %}
                                    <span style="color: #6c757d;">ìƒì„± ì•ˆë¨</span>
                                {% endif %}
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                    <button onclick="generateChart('{{ stock.ticker }}', event)" 
                                            id="generate-chart-btn-{{ stock.ticker }}"
                                            class="btn btn-sm {% if file_status.chart.button_status == 'green' %}btn-success{% else %}btn-info{% endif %}"
                                            data-ticker="{{ stock.ticker }}"
                                            data-is-us-stock="{{ file_status.is_us_stock|lower }}">ì°¨íŠ¸ ìƒì„±</button>
                                    <button onclick="viewChartWithConfirmation('{{ stock.ticker }}')" 
                                            id="view-analysis-btn-{{ stock.ticker }}"
                                            class="btn btn-sm {% if file_status.analysis.button_status == 'green' %}btn-success{% else %}btn-primary{% endif %}"
                                            data-ticker="{{ stock.ticker }}"
                                            data-is-us-stock="{{ file_status.is_us_stock|lower }}">AI ë¶„ì„ ë³´ê¸°</button>
                                    <form method="POST" action="{{ url_for('user_stock.remove_stock', list_id=stock_list.id, stock_id=stock.id) }}" 
                                          style="display: inline;">
                                        <button type="submit" 
                                                id="remove-stock-btn-{{ stock.ticker }}"
                                                class="btn btn-danger btn-sm" 
                                                onclick="return confirm('ì •ë§ ì¢…ëª© {{ stock.ticker }}ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                                            ì‚­ì œ
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div style="text-align: center; padding: 2rem; color: #666;">
            <p>ì•„ì§ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <a href="{{ url_for('user_stock.add_stock', list_id=stock_list.id) }}" 
               class="btn btn-success">ì²« ë²ˆì§¸ ì¢…ëª© ì¶”ê°€í•˜ê¸°</a>
        </div>
    {% endif %}
</div>

<div class="card">
    <h3>ğŸ”§ ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬</h3>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="{{ url_for('user_stock.edit_stock_list', list_id=stock_list.id) }}" 
           class="btn btn-warning">ë¦¬ìŠ¤íŠ¸ ìˆ˜ì •</a>
        
        {% if not stock_list.is_default %}
            <form method="POST" action="{{ url_for('user_stock.delete_stock_list', list_id=stock_list.id) }}" 
                  style="display: inline;">
                <button type="submit" class="btn btn-danger" 
                        onclick="return confirm('ì •ë§ ì´ ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì¢…ëª©ì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')">
                    ë¦¬ìŠ¤íŠ¸ ì‚­ì œ
                </button>
            </form>
        {% endif %}
        
        <a href="{{ url_for('user_stock.stock_lists') }}" class="btn btn-secondary">â† ë¦¬ìŠ¤íŠ¸ ëª©ë¡</a>
        <a href="{{ url_for('user_stock.dashboard') }}" class="btn btn-primary">ëŒ€ì‹œë³´ë“œ</a>
    </div>
</div>

{% if stocks %}
<div class="card">
    <h3>ğŸ“Š ë¶„ì„ ê²°ê³¼</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div style="text-align: center; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
            <h4>ğŸ“ˆ ë¶„ì„ ìš”ì•½</h4>
            <p>ì „ì²´ ì¢…ëª©ì˜ ë¶„ì„ ê²°ê³¼ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.</p>
            <a href="{{ url_for('summary_page') }}" class="btn btn-primary">ë³´ê¸°</a>
        </div>
        
        <div style="text-align: center; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
            <h4>ğŸ“Š ë‹¤ì¤‘ ìš”ì•½</h4>
            <p>ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ì˜ ë¶„ì„ ê²°ê³¼ë¥¼ ë¹„êµí•´ë³´ì„¸ìš”.</p>
            <a href="{{ url_for('multi_summary_page') }}" class="btn btn-primary">ë³´ê¸°</a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<style>
    .sort-indicator {
        margin-left: 5px;
        color: #6c757d;
    }
    .sort-indicator:after {
        content: "â†•";
    }
    th[data-sort="asc"] .sort-indicator:after {
        content: "â†‘";
        color: #007bff;
    }
    th[data-sort="desc"] .sort-indicator:after {
        content: "â†“";
        color: #007bff;
    }
    th:hover {
        background-color: #e9ecef !important;
    }
</style>
<script>
    // ì¸ë¼ì¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ (base.htmlì— ì •ì˜ë˜ì–´ ìˆë‹¤ë©´ ìƒëµ ê°€ëŠ¥)
    function showInlineMessage(message, type) {
        // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
        const existingMessage = document.getElementById('inline-message');
        if (existingMessage) {
            existingMessage.remove();
        }
        
        // ìƒˆ ë©”ì‹œì§€ ìƒì„±
        const messageDiv = document.createElement('div');
        messageDiv.id = 'inline-message';
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            max-width: 400px;
            word-wrap: break-word;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        `;
        
        if (type === 'success') {
            messageDiv.style.backgroundColor = '#28a745';
        } else {
            messageDiv.style.backgroundColor = '#dc3545';
        }
        
        messageDiv.textContent = message;
        
        // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
        
        document.body.appendChild(messageDiv);
        
        // 3ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.style.animation = 'slideOut 0.3s ease-in';
                messageDiv.style.transform = 'translateX(100%)';
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 300);
            }
        }, 3000);
    }

    // í…Œì´ë¸” ì •ë ¬ í•¨ìˆ˜
    function sortTable(columnIndex, dataType) {
        const table = document.getElementById('stockTable');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const header = table.querySelectorAll('th')[columnIndex];
        
        // í˜„ì¬ ì •ë ¬ ìƒíƒœ í™•ì¸
        const currentSort = header.getAttribute('data-sort');
        let newSort = 'asc';
        
        if (currentSort === 'asc') {
            newSort = 'desc';
        } else if (currentSort === 'desc') {
            newSort = 'asc';
        }
        
        // ëª¨ë“  í—¤ë”ì˜ ì •ë ¬ ìƒíƒœ ì´ˆê¸°í™”
        table.querySelectorAll('th').forEach(th => {
            th.setAttribute('data-sort', 'none');
        });
        
        // í˜„ì¬ í—¤ë”ì— ìƒˆë¡œìš´ ì •ë ¬ ìƒíƒœ ì„¤ì •
        header.setAttribute('data-sort', newSort);
        
        // í–‰ ì •ë ¬
        rows.sort((a, b) => {
            let aValue = a.cells[columnIndex].textContent.trim();
            let bValue = b.cells[columnIndex].textContent.trim();
            
            if (dataType === 'date') {
                // ë‚ ì§œ ì •ë ¬ - "ìƒì„± ì•ˆë¨" ì²˜ë¦¬
                if (aValue === 'ìƒì„± ì•ˆë¨') aValue = '1900-01-01 00:00';
                if (bValue === 'ìƒì„± ì•ˆë¨') bValue = '1900-01-01 00:00';
                
                // ë‚ ì§œ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜
                const aDate = new Date(aValue.replace(/\./g, '-'));
                const bDate = new Date(bValue.replace(/\./g, '-'));
                
                if (newSort === 'asc') {
                    return aDate - bDate;
                } else {
                    return bDate - aDate;
                }
            } else {
                // í…ìŠ¤íŠ¸ ì •ë ¬
                if (newSort === 'asc') {
                    return aValue.localeCompare(bValue);
                } else {
                    return bValue.localeCompare(aValue);
                }
            }
        });
        
        // ì •ë ¬ëœ í–‰ë“¤ì„ í…Œì´ë¸”ì— ë‹¤ì‹œ ì¶”ê°€
        rows.forEach(row => tbody.appendChild(row));
    }

    // ë²„íŠ¼ ìƒ‰ìƒ ë° ì‹œê°„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateButtonStatus(ticker, fileType, timestamp) {
        console.log(`Updating button status for ${ticker} ${fileType} with timestamp:`, timestamp);
        
        const buttonId = fileType === 'chart' ? `generate-chart-btn-${ticker}` : `view-analysis-btn-${ticker}`;
        const button = document.getElementById(buttonId);
        const timeCell = document.getElementById(`${fileType}-time-${ticker}`);
        
        if (!button || !timeCell) {
            console.error(`Button or time cell not found for ${ticker} ${fileType}`);
            return;
        }
        
        const isUsStock = button.dataset.isUsStock === 'true';
        const now = new Date();
        const fileTime = new Date(timestamp);
        
        // ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
        const formattedTime = fileTime.toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
        timeCell.innerHTML = `<span style="color: #28a745;">${formattedTime}</span>`;
        
        // ë²„íŠ¼ ìƒ‰ìƒ ê²°ì • ë¡œì§
        let shouldBeGreen = false;
        
        // ì‹œê°„ëŒ€ ì²˜ë¦¬
        let currentTime, fileTimeInTimezone;
        if (isUsStock) {
            // ë¯¸êµ­ EST ì‹œê°„ëŒ€
            currentTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
            fileTimeInTimezone = new Date(fileTime.toLocaleString("en-US", {timeZone: "America/New_York"}));
        } else {
            // í•œêµ­ KST ì‹œê°„ëŒ€
            currentTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
            fileTimeInTimezone = new Date(fileTime.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
        }
        
        if (isUsStock) {
            const currentHour = currentTime.getHours();
            const currentMinute = currentTime.getMinutes();
            const fileHour = fileTimeInTimezone.getHours();
            const fileMinute = fileTimeInTimezone.getMinutes();
            
            // ì‹œì¥ ì‹œê°„: 9:30 AM - 4:00 PM EST
            const isMarketHours = (currentHour > 9 || (currentHour === 9 && currentMinute >= 30)) && currentHour < 16;
            const fileInMarketHours = (fileHour > 9 || (fileHour === 9 && fileMinute >= 30)) && fileHour < 16;
            
            if (isMarketHours) {
                // ì‹œì¥ ì‹œê°„ ì¤‘: 1ì‹œê°„ ì´ë‚´ë©´ ì´ˆë¡ìƒ‰
                const timeDiff = (currentTime - fileTimeInTimezone) / (1000 * 60 * 60); // ì‹œê°„ ë‹¨ìœ„
                shouldBeGreen = timeDiff <= 1;
            } else {
                // ì‹œì¥ ì‹œê°„ ì™¸: íŒŒì¼ì´ ì‹œì¥ ì‹œê°„ ì™¸ì— ìƒì„±ë˜ì—ˆìœ¼ë©´ ì´ˆë¡ìƒ‰
                shouldBeGreen = !fileInMarketHours;
            }
        } else {
            const currentHour = currentTime.getHours();
            const currentMinute = currentTime.getMinutes();
            const fileHour = fileTimeInTimezone.getHours();
            const fileMinute = fileTimeInTimezone.getMinutes();
            
            // ì‹œì¥ ì‹œê°„: 9:00 AM - 3:30 PM KST
            const isMarketHours = (currentHour >= 9 && currentHour < 15) || (currentHour === 15 && currentMinute <= 30);
            const fileInMarketHours = (fileHour >= 9 && fileHour < 15) || (fileHour === 15 && fileMinute <= 30);
            
            if (isMarketHours) {
                // ì‹œì¥ ì‹œê°„ ì¤‘: 1ì‹œê°„ ì´ë‚´ë©´ ì´ˆë¡ìƒ‰
                const timeDiff = (currentTime - fileTimeInTimezone) / (1000 * 60 * 60); // ì‹œê°„ ë‹¨ìœ„
                shouldBeGreen = timeDiff <= 1;
            } else {
                // ì‹œì¥ ì‹œê°„ ì™¸: íŒŒì¼ì´ ì‹œì¥ ì‹œê°„ ì™¸ì— ìƒì„±ë˜ì—ˆìœ¼ë©´ ì´ˆë¡ìƒ‰
                shouldBeGreen = !fileInMarketHours;
            }
        }
        
        console.log(`Button color decision for ${ticker} ${fileType}: shouldBeGreen=${shouldBeGreen}`);
        
        // ë²„íŠ¼ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
        const oldClass = button.className;
        button.className = button.className.replace(/btn-(success|info|primary)/, 
            shouldBeGreen ? 'btn-success' : (fileType === 'chart' ? 'btn-info' : 'btn-primary'));
        
        console.log(`Button class changed from "${oldClass}" to "${button.className}"`);
    }

    async function generateChart(ticker, event) {
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'ìƒì„± ì¤‘...';
        button.disabled = true;

        try {
            const res = await fetch(`/generate_chart/${ticker}`);
            if (res.ok) {
                const result = await res.json();
                showInlineMessage(`${ticker} ì°¨íŠ¸ ìƒì„± ì™„ë£Œ! ì´ì œ 'AI ë¶„ì„ ë³´ê¸°'ë¥¼ í´ë¦­í•˜ì—¬ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`, 'success');
                
                // ì‹¤ì œ íŒŒì¼ ìƒíƒœë¥¼ ì„œë²„ì—ì„œ ê°€ì ¸ì™€ì„œ ì—…ë°ì´íŠ¸
                updateFileStatus(ticker);
            } else {
                const errorData = await res.json();
                showInlineMessage(`ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨: ${errorData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
            }
        } catch (error) {
            showInlineMessage(`ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
            console.error("Generate chart error:", error);
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    // ì„œë²„ì—ì„œ ì‹¤ì œ íŒŒì¼ ìƒíƒœë¥¼ ê°€ì ¸ì™€ì„œ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    async function updateFileStatus(ticker) {
        console.log(`Updating file status for ${ticker}`);
        try {
            const response = await fetch(`/user/api/file-status/${ticker}`);
            const data = await response.json();
            
            console.log(`File status response for ${ticker}:`, data);
            
            if (data.success) {
                // ì°¨íŠ¸ ìƒíƒœ ì—…ë°ì´íŠ¸
                if (data.chart.exists && data.chart.timestamp) {
                    updateButtonStatus(ticker, 'chart', data.chart.timestamp);
                }
                
                // ë¶„ì„ ìƒíƒœ ì—…ë°ì´íŠ¸
                if (data.analysis.exists && data.analysis.timestamp) {
                    updateButtonStatus(ticker, 'analysis', data.analysis.timestamp);
                }
            } else {
                console.error(`Failed to get file status for ${ticker}:`, data.error);
            }
        } catch (error) {
            console.error('Error updating file status:', error);
        }
    }

    // ë¶„ì„ ìƒì„± ìƒíƒœë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì²´í¬í•˜ëŠ” í•¨ìˆ˜
    function checkAnalysisStatus(ticker, intervalId) {
        fetch(`/user/api/file-status/${ticker}`)
            .then(response => response.json())
            .then(data => {
                console.log(`Analysis status check for ${ticker}:`, data);
                if (data.success && data.analysis.exists && data.analysis.timestamp) {
                    // ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìœ¼ë©´ ë²„íŠ¼ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
                    updateButtonStatus(ticker, 'analysis', data.analysis.timestamp);
                    clearInterval(intervalId);
                    showInlineMessage(`${ticker} AI ë¶„ì„ ìƒì„± ì™„ë£Œ!`, 'success');
                }
            })
            .catch(error => {
                console.error('Error checking analysis status:', error);
                clearInterval(intervalId);
            });
    }

    function viewChartWithConfirmation(ticker) {
        // ë¨¼ì € ê¸°ì¡´ ë¶„ì„ì´ ìˆëŠ”ì§€ í™•ì¸
        fetch(`/check_existing_analysis/${ticker}`)
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    // ê¸°ì¡´ ë¶„ì„ì´ ìˆìœ¼ë©´ ì‚¬ìš©ìì—ê²Œ í™•ì¸
                    const userChoice = confirm(`${data.message}\n\n"í™•ì¸"ì„ ëˆ„ë¥´ë©´ ìƒˆë¡œ ìƒì„±í•˜ê³ , "ì·¨ì†Œ"ë¥¼ ëˆ„ë¥´ë©´ ê¸°ì¡´ íŒŒì¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.`);
                    
                    if (userChoice) {
                        // ìƒˆë¡œ ìƒì„±
                        window.open(`/force_new_analysis_with_timestamp/${ticker}`, '_blank');
                        
                        // ë¶„ì„ ìƒì„± ì™„ë£Œë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì²´í¬
                        const intervalId = setInterval(() => {
                            checkAnalysisStatus(ticker, intervalId);
                        }, 2000); // 2ì´ˆë§ˆë‹¤ ì²´í¬
                        
                        // ìµœëŒ€ 5ë¶„ í›„ ì²´í¬ ì¤‘ë‹¨
                        setTimeout(() => {
                            clearInterval(intervalId);
                        }, 300000);
                    } else {
                        // ê¸°ì¡´ íŒŒì¼ ì‚¬ìš©
                        window.open(`/view_existing_chart/${ticker}`, '_blank');
                    }
                } else {
                    // ê¸°ì¡´ ë¶„ì„ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ìƒˆë¡œ ìƒì„±
                    window.open(`/force_new_analysis_with_timestamp/${ticker}`, '_blank');
                    
                    // ë¶„ì„ ìƒì„± ì™„ë£Œë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì²´í¬
                    const intervalId = setInterval(() => {
                        checkAnalysisStatus(ticker, intervalId);
                    }, 2000); // 2ì´ˆë§ˆë‹¤ ì²´í¬
                    
                    // ìµœëŒ€ 5ë¶„ í›„ ì²´í¬ ì¤‘ë‹¨
                    setTimeout(() => {
                        clearInterval(intervalId);
                    }, 300000);
                }
            })
            .catch(error => {
                console.error('Error checking existing analysis:', error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ ìƒˆë¡œ ìƒì„±
                window.open(`/force_new_analysis_with_timestamp/${ticker}`, '_blank');
            });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  ì¢…ëª©ì˜ íŒŒì¼ ìƒíƒœ í™•ì¸
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded, checking file status for all stocks...');
        
        // í…Œì´ë¸”ì˜ ëª¨ë“  ì¢…ëª© í–‰ì„ ì°¾ê¸°
        const stockRows = document.querySelectorAll('#stockTable tbody tr');
        
        stockRows.forEach(row => {
            // ì¢…ëª© ì½”ë“œ ì¶”ì¶œ
            const tickerCell = row.querySelector('td:first-child');
            if (tickerCell) {
                const ticker = tickerCell.textContent.trim();
                console.log(`Found ticker: ${ticker}`);
                
                // ê° ì¢…ëª©ì˜ íŒŒì¼ ìƒíƒœ í™•ì¸
                updateFileStatus(ticker);
            }
        });
    });
</script>
{% endblock %} 