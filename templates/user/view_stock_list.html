{% extends "base.html" %}

{% block title %}{{ stock_list.name }} - ì¢…ëª© ë¦¬ìŠ¤íŠ¸{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>ğŸ“Š {{ stock_list.name }}</h2>
        <a href="{{ url_for('user_stock.stock_lists') }}" class="btn btn-secondary">â† ë¦¬ìŠ¤íŠ¸ ëª©ë¡ìœ¼ë¡œ</a>
    </div>
    
    {% if stock_list.description %}
        <p style="color: #666; margin-bottom: 1rem;">{{ stock_list.description }}</p>
    {% endif %}
    
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <p><strong>ì¢…ëª© ìˆ˜:</strong> {{ stocks|length }}ê°œ</p>
        <p><strong>ìƒì„±ì¼:</strong> {{ stock_list.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
        {% if stock_list.is_public %}
            <p><strong>ìƒíƒœ:</strong> <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">ê³µê°œ</span></p>
        {% endif %}
    </div>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>ğŸ“ˆ ì¢…ëª© ëª©ë¡ ({{ stocks|length }}ê°œ)</h3>
        <div style="display: flex; gap: 0.5rem;">
            <a href="{{ url_for('user_stock.add_stock', list_id=stock_list.id) }}" class="btn btn-success">â• ì¢…ëª© ì¶”ê°€</a>
            {% if stocks %}
                <form method="POST" action="{{ url_for('user_stock.bulk_generate', list_id=stock_list.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-primary" 
                            onclick="return confirm('ì´ ë¦¬ìŠ¤íŠ¸ì˜ ëª¨ë“  ì¢…ëª©ì— ëŒ€í•´ ì¼ê´„ ìƒì„±ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                        ğŸš€ ì¼ê´„ ìƒì„±
                    </button>
                </form>
            {% endif %}
        </div>
    </div>
    
    {% if stocks %}
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">ì¢…ëª© ì½”ë“œ</th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">ì¢…ëª©ëª…</th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">ì¶”ê°€ì¼</th>
                        <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid #dee2e6;">ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in stocks %}
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 0.75rem;">
                                <strong>{{ stock.ticker }}</strong>
                            </td>
                            <td style="padding: 0.75rem;">
                                {{ stock.name or stock.ticker }}
                            </td>
                            <td style="padding: 0.75rem; color: #666; font-size: 0.9rem;">
                                {{ stock.created_at.strftime('%Y-%m-%d %H:%M') if stock.created_at else 'N/A' }}
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                    <button onclick="generateChart('{{ stock.ticker }}', event)" 
                                            id="generate-chart-btn-{{ stock.ticker }}"
                                            class="btn btn-info btn-sm">ğŸ“Š ì°¨íŠ¸ ìƒì„±</button>
                                    <button onclick="viewChartWithConfirmation('{{ stock.ticker }}')" 
                                            id="view-chart-btn-{{ stock.ticker }}"
                                            class="btn btn-primary btn-sm">ğŸ“ˆ ì°¨íŠ¸ ë³´ê¸°</button>
                                    <form method="POST" action="{{ url_for('user_stock.remove_stock', list_id=stock_list.id, stock_id=stock.id) }}" 
                                          style="display: inline;">
                                        <button type="submit" 
                                                id="remove-stock-btn-{{ stock.ticker }}"
                                                class="btn btn-danger btn-sm" 
                                                onclick="return confirm('ì •ë§ ì¢…ëª© {{ stock.ticker }}ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                                            ì‚­ì œ
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div style="text-align: center; padding: 2rem; color: #666;">
            <p>ì•„ì§ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <a href="{{ url_for('user_stock.add_stock', list_id=stock_list.id) }}" 
               class="btn btn-success">ì²« ë²ˆì§¸ ì¢…ëª© ì¶”ê°€í•˜ê¸°</a>
        </div>
    {% endif %}
</div>

<div class="card">
    <h3>ğŸ”§ ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬</h3>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="{{ url_for('user_stock.edit_stock_list', list_id=stock_list.id) }}" 
           class="btn btn-warning">âœï¸ ë¦¬ìŠ¤íŠ¸ ìˆ˜ì •</a>
        
        {% if not stock_list.is_default %}
            <form method="POST" action="{{ url_for('user_stock.delete_stock_list', list_id=stock_list.id) }}" 
                  style="display: inline;">
                <button type="submit" class="btn btn-danger" 
                        onclick="return confirm('ì •ë§ ì´ ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì¢…ëª©ì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')">
                    ğŸ—‘ï¸ ë¦¬ìŠ¤íŠ¸ ì‚­ì œ
                </button>
            </form>
        {% endif %}
        
        <a href="{{ url_for('user_stock.stock_lists') }}" class="btn btn-secondary">â† ë¦¬ìŠ¤íŠ¸ ëª©ë¡</a>
        <a href="{{ url_for('user_stock.dashboard') }}" class="btn btn-primary">ëŒ€ì‹œë³´ë“œ</a>
    </div>
</div>

{% if stocks %}
<div class="card">
    <h3>ğŸ“Š ë¶„ì„ ê²°ê³¼</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div style="text-align: center; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
            <h4>ğŸ“ˆ ë¶„ì„ ìš”ì•½</h4>
            <p>ì „ì²´ ì¢…ëª©ì˜ ë¶„ì„ ê²°ê³¼ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.</p>
            <a href="{{ url_for('summary_page') }}" class="btn btn-primary">ë³´ê¸°</a>
        </div>
        
        <div style="text-align: center; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
            <h4>ğŸ“Š ë‹¤ì¤‘ ìš”ì•½</h4>
            <p>ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ì˜ ë¶„ì„ ê²°ê³¼ë¥¼ ë¹„êµí•´ë³´ì„¸ìš”.</p>
            <a href="{{ url_for('multi_summary_page') }}" class="btn btn-primary">ë³´ê¸°</a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // ì¸ë¼ì¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ (base.htmlì— ì •ì˜ë˜ì–´ ìˆë‹¤ë©´ ìƒëµ ê°€ëŠ¥)
    function showInlineMessage(message, type) {
        // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
        const existingMessage = document.getElementById('inline-message');
        if (existingMessage) {
            existingMessage.remove();
        }
        
        // ìƒˆ ë©”ì‹œì§€ ìƒì„±
        const messageDiv = document.createElement('div');
        messageDiv.id = 'inline-message';
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            max-width: 400px;
            word-wrap: break-word;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        `;
        
        if (type === 'success') {
            messageDiv.style.backgroundColor = '#28a745';
        } else {
            messageDiv.style.backgroundColor = '#dc3545';
        }
        
        messageDiv.textContent = message;
        
        // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
        
        document.body.appendChild(messageDiv);
        
        // 3ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.style.animation = 'slideOut 0.3s ease-in';
                messageDiv.style.transform = 'translateX(100%)';
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 300);
            }
        }, 3000);
    }

    async function generateChart(ticker, event) {
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'ìƒì„± ì¤‘...';
        button.disabled = true;

        try {
            const res = await fetch(`/generate_chart/${ticker}`);
            if (res.ok) {
                const result = await res.json();
                showInlineMessage(`âœ… ${ticker} ì°¨íŠ¸ ìƒì„± ì™„ë£Œ! ì´ì œ 'ì°¨íŠ¸ ë³´ê¸°'ë¥¼ í´ë¦­í•˜ì—¬ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`, 'success');
            } else {
                const errorData = await res.json();
                showInlineMessage(`âŒ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨: ${errorData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
            }
        } catch (error) {
            showInlineMessage(`âŒ ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
            console.error("Generate chart error:", error);
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    function viewChartWithConfirmation(ticker) {
        // ë¨¼ì € ê¸°ì¡´ ë¶„ì„ì´ ìˆëŠ”ì§€ í™•ì¸
        fetch(`/check_existing_analysis/${ticker}`)
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    // ê¸°ì¡´ ë¶„ì„ì´ ìˆìœ¼ë©´ ì‚¬ìš©ìì—ê²Œ í™•ì¸
                    const userChoice = confirm(`${data.message}\n\n"í™•ì¸"ì„ ëˆ„ë¥´ë©´ ìƒˆë¡œ ìƒì„±í•˜ê³ , "ì·¨ì†Œ"ë¥¼ ëˆ„ë¥´ë©´ ê¸°ì¡´ íŒŒì¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.`);
                    
                    if (userChoice) {
                        // ìƒˆë¡œ ìƒì„±
                        window.open(`/force_new_analysis_with_timestamp/${ticker}`, '_blank');
                    } else {
                        // ê¸°ì¡´ íŒŒì¼ ì‚¬ìš©
                        window.open(`/view_existing_chart/${ticker}`, '_blank');
                    }
                } else {
                    // ê¸°ì¡´ ë¶„ì„ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ìƒˆë¡œ ìƒì„±
                    window.open(`/force_new_analysis_with_timestamp/${ticker}`, '_blank');
                }
            })
            .catch(error => {
                console.error('Error checking existing analysis:', error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ ìƒˆë¡œ ìƒì„±
                window.open(`/force_new_analysis_with_timestamp/${ticker}`, '_blank');
            });
    }
</script>
{% endblock %} 