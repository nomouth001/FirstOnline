{% extends "base.html" %}

{% block title %}{{ stock_list.name }}ì— ì¢…ëª© ì¶”ê°€{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>â• {{ stock_list.name }}ì— ì¢…ëª© ì¶”ê°€</h2>
        <a href="{{ url_for('user_stock.view_stock_list', list_id=stock_list.id) }}" class="btn btn-secondary">â† ë¦¬ìŠ¤íŠ¸ë¡œ</a>
    </div>
    <p>ê´€ì‹¬ ìˆëŠ” ì£¼ì‹ ì¢…ëª©ì„ ì´ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•˜ì„¸ìš”.</p>
</div>

<div class="card">
    <h3>ğŸ” ì¢…ëª© ê²€ìƒ‰</h3>
    <div style="margin-bottom: 1rem;">
        <input type="text" id="stockSearch" placeholder="ì¢…ëª© ì½”ë“œë‚˜ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." 
               style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        <div id="searchResults" style="margin-top: 0.5rem; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; display: none;"></div>
    </div>
</div>

<div class="card">
    <h3>ğŸ“ˆ ì¢…ëª© ì •ë³´ ì…ë ¥</h3>
    
    <form method="POST" style="max-width: 600px;">
        {{ form.hidden_tag() }}
        
        <div style="margin-bottom: 1rem;">
            {{ form.ticker.label(style="display: block; margin-bottom: 0.5rem; font-weight: bold;") }}
            {{ form.ticker(style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;", placeholder="ì˜ˆ: AAPL, 005930.KS") }}
            <small style="color: #666; display: block; margin-top: 0.25rem;">
                ë¯¸êµ­ ì£¼ì‹: AAPL, GOOGL ë“± | í•œêµ­ ì£¼ì‹: 005930.KS, 000660.KS ë“±
            </small>
            {% if form.ticker.errors %}
                <div style="color: #dc3545; font-size: 0.9rem; margin-top: 0.25rem;">
                    {% for error in form.ticker.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div style="margin-bottom: 1rem;">
            {{ form.name.label(style="display: block; margin-bottom: 0.5rem; font-weight: bold;") }}
            {{ form.name(style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;", placeholder="ì¢…ëª©ëª… (ì„ íƒì‚¬í•­)") }}
            <small style="color: #666; display: block; margin-top: 0.25rem;">
                ì¢…ëª©ëª…ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ì¡°íšŒë©ë‹ˆë‹¤. ë¹„ì›Œë‘ì–´ë„ ë©ë‹ˆë‹¤.
            </small>
            {% if form.name.errors %}
                <div style="color: #dc3545; font-size: 0.9rem; margin-top: 0.25rem;">
                    {% for error in form.name.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div id="stockInfo" style="margin-bottom: 1rem; padding: 1rem; background-color: #f8f9fa; border-radius: 4px; display: none;">
            <h4>ğŸ“Š ì¢…ëª© ì •ë³´</h4>
            <div id="stockDetails"></div>
        </div>
        
        <div style="margin-bottom: 1rem;">
            <p style="color: #666; font-size: 0.9rem;">
                <strong>í˜„ì¬ ë¦¬ìŠ¤íŠ¸:</strong> {{ stock_list.name }}<br>
                <strong>í˜„ì¬ ì¢…ëª© ìˆ˜:</strong> {{ stock_list.stocks|length }}ê°œ / ìµœëŒ€ 50ê°œ
            </p>
            {% if stock_list.stocks|length >= 45 %}
                <div style="padding: 0.5rem; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404;">
                    âš ï¸ ë¦¬ìŠ¤íŠ¸ë‹¹ ìµœëŒ€ 50ê°œì˜ ì¢…ëª©ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ {{ stock_list.stocks|length }}ê°œ)
                </div>
            {% endif %}
        </div>
        
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button type="submit" class="btn btn-success">â• ì¢…ëª© ì¶”ê°€</button>
            <a href="{{ url_for('user_stock.view_stock_list', list_id=stock_list.id) }}" class="btn btn-secondary">ì·¨ì†Œ</a>
        </div>
    </form>
</div>

<div class="card">
    <h3>ğŸ’¡ ì¢…ëª© ì½”ë“œ ê°€ì´ë“œ</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem;">
            <h4>ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ì£¼ì‹</h4>
            <ul style="margin: 0; padding-left: 1.5rem;">
                <li>AAPL - Apple Inc.</li>
                <li>GOOGL - Alphabet Inc.</li>
                <li>MSFT - Microsoft Corp.</li>
                <li>TSLA - Tesla Inc.</li>
                <li>AMZN - Amazon.com Inc.</li>
            </ul>
        </div>
        
        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem;">
            <h4>ğŸ‡°ğŸ‡· í•œêµ­ ì£¼ì‹</h4>
            <ul style="margin: 0; padding-left: 1.5rem;">
                <li>005930.KS - ì‚¼ì„±ì „ì</li>
                <li>000660.KS - SKí•˜ì´ë‹‰ìŠ¤</li>
                <li>035420.KS - NAVER</li>
                <li>051910.KS - LGí™”í•™</li>
                <li>006400.KS - ì‚¼ì„±SDI</li>
            </ul>
        </div>
        
        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem;">
            <h4>ğŸ“Š ì§€ìˆ˜</h4>
            <ul style="margin: 0; padding-left: 1.5rem;">
                <li>^GSPC - S&P 500</li>
                <li>^DJI - Dow Jones</li>
                <li>^IXIC - NASDAQ</li>
                <li>^KS11 - KOSPI</li>
                <li>^KQ11 - KOSDAQ</li>
            </ul>
        </div>
    </div>
</div>

<div class="card">
    <h3>ğŸš€ ë¹ ë¥¸ ì‘ì—…</h3>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="{{ url_for('user_stock.view_stock_list', list_id=stock_list.id) }}" class="btn btn-primary">ğŸ“Š ë¦¬ìŠ¤íŠ¸ ë³´ê¸°</a>
        <a href="{{ url_for('user_stock.stock_lists') }}" class="btn btn-secondary">ë¦¬ìŠ¤íŠ¸ ëª©ë¡</a>
        <a href="{{ url_for('user_stock.dashboard') }}" class="btn btn-primary">ëŒ€ì‹œë³´ë“œ</a>
    </div>
</div>

<script>
let searchTimeout;

// ì¢…ëª© ê²€ìƒ‰ ê¸°ëŠ¥
document.getElementById('stockSearch').addEventListener('input', function() {
    const query = this.value.trim();
    const resultsDiv = document.getElementById('searchResults');
    
    clearTimeout(searchTimeout);
    
    if (query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    searchTimeout = setTimeout(() => {
        fetch(`/user/search-stocks?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                resultsDiv.innerHTML = '';
                
                if (data.length > 0) {
                    data.forEach(stock => {
                        const div = document.createElement('div');
                        div.style.padding = '0.5rem';
                        div.style.borderBottom = '1px solid #eee';
                        div.style.cursor = 'pointer';
                        div.innerHTML = `
                            <strong>${stock.ticker}</strong> - ${stock.name}
                            ${stock.sector ? `<br><small style="color: #666;">${stock.sector}</small>` : ''}
                        `;
                        
                        div.addEventListener('click', () => {
                            document.getElementById('ticker').value = stock.ticker;
                            document.getElementById('name').value = stock.name;
                            document.getElementById('stockSearch').value = '';
                            resultsDiv.style.display = 'none';
                            
                            // ì¢…ëª© ì •ë³´ ì¡°íšŒ
                            lookupStockInfo(stock.ticker);
                        });
                        
                        resultsDiv.appendChild(div);
                    });
                    resultsDiv.style.display = 'block';
                } else {
                    resultsDiv.innerHTML = '<div style="padding: 0.5rem; color: #666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    resultsDiv.style.display = 'block';
                }
            })
            .catch(error => {
                console.log('ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                resultsDiv.innerHTML = '<div style="padding: 0.5rem; color: #dc3545;">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                resultsDiv.style.display = 'block';
            });
    }, 300);
});

// ì¢…ëª© ì½”ë“œ ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ ì¢…ëª©ëª… ì¡°íšŒ
document.getElementById('ticker').addEventListener('blur', function() {
    const ticker = this.value.trim().toUpperCase();
    if (ticker) {
        lookupStockInfo(ticker);
    }
});

// ì¢…ëª© ì •ë³´ ì¡°íšŒ í•¨ìˆ˜
function lookupStockInfo(ticker) {
    fetch(`/user/lookup-ticker?ticker=${ticker}`)
        .then(response => response.json())
        .then(data => {
            const stockInfoDiv = document.getElementById('stockInfo');
            const stockDetailsDiv = document.getElementById('stockDetails');
            
            if (data.success && data.name) {
                document.getElementById('name').value = data.name;
                
                let details = `<p><strong>${data.name}</strong></p>`;
                if (data.sector) details += `<p><strong>ì„¹í„°:</strong> ${data.sector}</p>`;
                if (data.industry) details += `<p><strong>ì‚°ì—…:</strong> ${data.industry}</p>`;
                if (data.country) details += `<p><strong>êµ­ê°€:</strong> ${data.country}</p>`;
                if (data.market_cap) {
                    const marketCap = (data.market_cap / 1e9).toFixed(2);
                    details += `<p><strong>ì‹œê°€ì´ì•¡:</strong> ${marketCap}B USD</p>`;
                }
                
                stockDetailsDiv.innerHTML = details;
                stockInfoDiv.style.display = 'block';
            } else {
                stockInfoDiv.style.display = 'none';
            }
        })
        .catch(error => {
            console.log('ì¢…ëª©ëª… ì¡°íšŒ ì‹¤íŒ¨:', error);
            document.getElementById('stockInfo').style.display = 'none';
        });
}

// ê²€ìƒ‰ ê²°ê³¼ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(e) {
    const searchResults = document.getElementById('searchResults');
    const stockSearch = document.getElementById('stockSearch');
    
    if (!searchResults.contains(e.target) && !stockSearch.contains(e.target)) {
        searchResults.style.display = 'none';
    }
});
</script>
{% endblock %} 