<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¢…ëª© ë¶„ì„ ìš”ì•½</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 40px; 
            background-color: #f9f9f9; 
        }
        h2 { 
            margin-bottom: 30px; 
            color: #007bff;
        }
        .list-selector { 
            margin-bottom: 20px; 
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .list-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        .list-selector button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .list-selector button:hover {
            background-color: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #e9ecef;
        }
        .summary-box {
            max-height: none; /* ë†’ì´ ì œí•œ ì œê±° */
            overflow-y: visible; /* ìŠ¤í¬ë¡¤ ì œê±° */
            padding: 8px;
            border: 1px solid #eee;
            background-color: #fcfcfc;
            border-radius: 4px;
            line-height: 1.3; /* ì¤„ ê°„ê²© ì•½ê°„ ì¤„ì„ */
        }
        
        /* br íƒœê·¸ ê°„ê²© ì¤„ì´ê¸° */
        .summary-box br {
            display: block;
            margin: 2px 0; /* br íƒœê·¸ ìœ„ì•„ë˜ ê°„ê²©ì„ 2pxë¡œ ì„¤ì • */
            line-height: 0.5; /* ì¤„ ë†’ì´ ë” ì¤„ì„ */
        }
        
        /* ìš”ì•½ í…ìŠ¤íŠ¸ ë‚´ ë¬¸ë‹¨ ê°„ê²© ì¡°ì ˆ */
        .summary-box p {
            margin: 4px 0; /* ë¬¸ë‹¨ ê°„ê²© ì¤„ì„ */
        }
        
        /* í…Œì´ë¸” í–‰ ë†’ì´ ìë™ ì¡°ì ˆ */
        td {
            height: auto; /* ë†’ì´ ìë™ ì¡°ì ˆ */
            vertical-align: top; /* ìƒë‹¨ ì •ë ¬ ìœ ì§€ */
        }
        .error-message {
            color: #dc3545;
            font-weight: bold;
        }
        .success-message {
            color: #28a745;
            font-weight: bold;
        }
        .chart-link {
            display: inline-block;
            padding: 6px 12px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }
        .chart-link:hover {
            background-color: #218838;
        }
        .stats-box {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h2>ğŸ“ˆ ëª¨ë“  ì¢…ëª© ë¶„ì„ ìš”ì•½</h2>

    <div class="list-selector">
        <label for="stock-list-select-summary">ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì„ íƒ:</label>
        <select id="stock-list-select-summary" onchange="loadAllSummaries()">
        </select>
        <button onclick="loadAllSummaries()">ìš”ì•½ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <div id="stats-box" class="stats-box">
        <h3 style="margin-top: 0; color: #007bff;">ğŸ“Š ë¶„ì„ í†µê³„</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number" id="total-count">0</div>
                <div class="stat-label">ì´ ì¢…ëª© ìˆ˜</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="analyzed-count">0</div>
                <div class="stat-label">ë¶„ì„ ì™„ë£Œ</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="success-rate">0%</div>
                <div class="stat-label">ì„±ê³µë¥ </div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="latest-date">-</div>
                <div class="stat-label">ìµœì‹  ë¶„ì„ì¼</div>
            </div>
        </div>
    </div>

    <table id="summary-table">
        <thead>
            <tr>
                <th>í‹°ì»¤</th>
                <th>ìƒìŠ¹ë¥ </th>
                <th>Gemini AI ìš”ì•½</th>
                <th>ë§ˆì§€ë§‰ ë¶„ì„ì¼</th>
                <th>ì°¨íŠ¸ ë¶„ì„ ë³´ê¸°</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        // ì¸ë¼ì¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showInlineMessage(message, type) {
            // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
            const existingMessage = document.getElementById('inline-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // ìƒˆ ë©”ì‹œì§€ ìƒì„±
            const messageDiv = document.createElement('div');
            messageDiv.id = 'inline-message';
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                max-width: 400px;
                word-wrap: break-word;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease-out;
            `;
            
            if (type === 'success') {
                messageDiv.style.backgroundColor = '#28a745';
            } else {
                messageDiv.style.backgroundColor = '#dc3545';
            }
            
            messageDiv.textContent = message;
            
            // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(messageDiv);
            
            // 3ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideOut 0.3s ease-in';
                    messageDiv.style.transform = 'translateX(100%)';
                    messageDiv.style.opacity = '0';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.remove();
                        }
                    }, 300);
                }
            }, 3000);
        }

        async function loadStockListsForSummary() {
            try {
                const res = await fetch('/get_stock_lists');
                const lists = await res.json();
                const select = document.getElementById('stock-list-select-summary');
                select.innerHTML = '';
                lists.forEach(listName => {
                    const option = document.createElement('option');
                    option.value = listName;
                    option.textContent = listName;
                    select.appendChild(option);
                });

                // ì´ˆê¸° ë¡œë“œ ì‹œ ê¸°ë³¸ ë¦¬ìŠ¤íŠ¸ ì„ íƒ ë° ìš”ì•½ ë¡œë“œ
                const currentListRes = await fetch('/get_current_stock_list');
                const currentListData = await currentListRes.json();
                if (lists.includes(currentListData.current_list)) {
                    select.value = currentListData.current_list;
                } else if (lists.length > 0) {
                    select.value = lists[0];
                }
                
                loadAllSummaries();

            } catch (error) {
                console.error("Error loading stock lists for summary page:", error);
                showInlineMessage("ì¢…ëª© ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", 'error');
            }
        }

        async function loadAllSummaries() {
            const select = document.getElementById('stock-list-select-summary');
            const selectedListName = select.value;
            const tbody = document.querySelector('#summary-table tbody');
            const statsBox = document.getElementById('stats-box');
            
            tbody.innerHTML = '<tr><td colspan="5" class="loading">ë¶„ì„ ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
            statsBox.style.display = 'none';

            if (!selectedListName) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">ì„ íƒëœ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            try {
                const res = await fetch(`/get_all_summaries/${selectedListName}`);
                if (!res.ok) {
                    const errorData = await res.json();
                    tbody.innerHTML = `<tr><td colspan="5" class="error-message">ìš”ì•½ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${errorData.error}</td></tr>`;
                    console.error("Failed to load summaries:", errorData.error);
                    return;
                }
                const summaries = await res.json();
                tbody.innerHTML = '';

                if (Object.keys(summaries).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="no-data">í•´ë‹¹ ë¦¬ìŠ¤íŠ¸ì— ë¶„ì„ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë©”ì¸ í˜ì´ì§€ì—ì„œ "ëª¨ë“  ì¢…ëª© ì°¨íŠ¸ & AI ë¶„ì„ ì¼ê´„ìƒì„±"ì„ ë¨¼ì € ì‹¤í–‰í•˜ì‹­ì‹œì˜¤.</td></tr>';
                } else {
                    // í†µê³„ ê³„ì‚°
                    const tickers = Object.keys(summaries);
                    const analyzedCount = tickers.length;
                    let successCount = 0;
                    let latestDate = null;
                    
                    // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ê°€ê²© ë³€í™”ìœ¨ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
                    const sortedTickers = tickers.sort((a, b) => {
                        const rateA = summaries[a].price_change_rate || 0;
                        const rateB = summaries[b].price_change_rate || 0;
                        return rateB - rateA; // ë‚´ë¦¼ì°¨ìˆœ (ë†’ì€ ìˆ˜ìµë¥ ì´ ë¨¼ì €)
                    });
                    
                    for (const ticker of sortedTickers) {
                        const summary = summaries[ticker];
                        const tr = document.createElement('tr');
                        
                        // ì„±ê³µ ì—¬ë¶€ íŒë‹¨ (ìš”ì•½ì´ ìˆê³  "ë¶„ì„ ì‹¤íŒ¨"ê°€ ì•„ë‹Œ ê²½ìš°)
                        const isSuccess = summary.gemini_summary && 
                                        !summary.gemini_summary.includes("ë¶„ì„ ì‹¤íŒ¨") && 
                                        !summary.gemini_summary.includes("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜");
                        if (isSuccess) successCount++;
                        
                        // ìµœì‹  ë‚ ì§œ ì°¾ê¸°
                        if (summary.last_analyzed_date) {
                            const date = new Date(summary.last_analyzed_date);
                            if (!latestDate || date > latestDate) {
                                latestDate = date;
                            }
                        }
                        
                        // ê°€ê²© ë³€í™”ìœ¨ í‘œì‹œ (ìƒ‰ìƒ í¬í•¨)
                        const priceChange = summary.price_change_rate || 0;
                        const priceChangeColor = priceChange > 0 ? 'color: #e74c3c; font-weight: bold;' : 
                                               priceChange < 0 ? 'color: #3498db; font-weight: bold;' : 
                                               'color: #7f8c8d;';
                        const priceChangeText = priceChange > 0 ? `+${priceChange}%` : `${priceChange}%`;
                        
                        tr.innerHTML = `
                            <td><strong>${ticker}</strong></td>
                            <td style="${priceChangeColor}">${priceChangeText}</td>
                            <td><div class="summary-box">${summary.gemini_summary || 'ë¶„ì„ ì‹¤íŒ¨ ë˜ëŠ” ìš”ì•½ ì—†ìŒ.'}</div></td>
                            <td>${summary.last_analyzed_date || 'N/A'}</td>
                            <td><a href="/chart_analysis/${selectedListName}/${ticker}" target="_blank" class="chart-link">ğŸ“Š ì°¨íŠ¸ ë¶„ì„ ë³´ê¸°</a></td>
                        `;
                        tbody.appendChild(tr);
                    }
                    
                    // í†µê³„ í‘œì‹œ
                    document.getElementById('total-count').textContent = analyzedCount;
                    document.getElementById('analyzed-count').textContent = successCount;
                    document.getElementById('success-rate').textContent = analyzedCount > 0 ? `${((successCount/analyzedCount)*100).toFixed(1)}%` : '0%';
                    document.getElementById('latest-date').textContent = latestDate ? latestDate.toLocaleDateString('ko-KR') : '-';
                    statsBox.style.display = 'block';
                }
            } catch (error) {
                console.error("Error loading all summaries:", error);
                tbody.innerHTML = `<tr><td colspan="5" class="error-message">ìš”ì•½ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</td></tr>`;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìš”ì•½ì„ í‘œì‹œ
        loadStockListsForSummary();
    </script>
</body>
</html>