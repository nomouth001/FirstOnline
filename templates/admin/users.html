{% extends "base.html" %}

{% block title %}ì‚¬ìš©ì ê´€ë¦¬{% endblock %}

{% block content %}
<div class="card">
    <h1>ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</h1>
    <p>ì‹œìŠ¤í…œì˜ ëª¨ë“  ì‚¬ìš©ìë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
</div>

<div class="card">
    <h3>ğŸ” ì‚¬ìš©ì ê²€ìƒ‰</h3>
    <form method="GET" action="{{ url_for('admin.admin_users') }}" class="search-form">
        <div style="display: flex; gap: 1rem; align-items: center;">
            <input type="text" name="search" value="{{ search_query }}" 
                   placeholder="ì‚¬ìš©ìëª…, ì´ë©”ì¼, ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." 
                   style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
            {% if search_query %}
                <a href="{{ url_for('admin.admin_users') }}" class="btn btn-secondary">ì´ˆê¸°í™”</a>
            {% endif %}
        </div>
    </form>
</div>

<div class="card">
    <h3>ì‚¬ìš©ì ëª©ë¡</h3>
    {% if search_query %}
        <p style="color: #007bff; margin-bottom: 1rem;">
            ğŸ” "{{ search_query }}" ê²€ìƒ‰ ê²°ê³¼: {{ users|length }}ëª…ì˜ ì‚¬ìš©ì
        </p>
    {% endif %}
    
    {% if users %}
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ì‚¬ìš©ìëª…</th>
                    <th>ì´ë©”ì¼</th>
                    <th>ì´ë¦„</th>
                    <th>ê°€ì…ì¼</th>
                    <th>ìƒíƒœ</th>
                    <th>ê¶Œí•œ</th>
                    <th>ë¦¬ìŠ¤íŠ¸</th>
                    <th>ì‘ì—…</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>
                        {{ user.username }}
                        {% if user.id == current_user.id %}
                            <span style="color: #007bff;">(í˜„ì¬ ì‚¬ìš©ì)</span>
                        {% endif %}
                    </td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.get_full_name() }}</td>
                    <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        {% if user.is_active %}
                            <span style="color: #28a745;">í™œì„±</span>
                        {% elif user.is_withdrawn %}
                            <span style="color: #dc3545;">íƒˆí‡´</span>
                        {% else %}
                            <span style="color: #dc3545;">ë¹„í™œì„±</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_administrator() %}
                            <span class="admin-badge">ê´€ë¦¬ì</span>
                        {% else %}
                            <span style="color: #6c757d;">ì¼ë°˜ ì‚¬ìš©ì</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('admin.user_stock_lists', user_id=user.id) }}" 
                           class="btn btn-info btn-sm">
                            ğŸ“Š ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬ ({{ user.stock_lists|length }})
                        </a>
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            {% if user.id != current_user.id %}
                                {% if not user.is_withdrawn %}
                                    <form method="POST" action="{{ url_for('admin.toggle_admin', user_id=user.id) }}" style="display: inline;">
                                        <button type="submit" class="btn btn-warning" style="font-size: 0.8rem;">
                                            {% if user.is_administrator() %}
                                                ê´€ë¦¬ì í•´ì œ
                                            {% else %}
                                                ê´€ë¦¬ì ì§€ì •
                                            {% endif %}
                                        </button>
                                    </form>
                                    
                                    <form method="POST" action="{{ url_for('admin.toggle_active', user_id=user.id) }}" style="display: inline;">
                                        <button type="submit" class="btn btn-{% if user.is_active %}danger{% else %}success{% endif %}" style="font-size: 0.8rem;">
                                            {% if user.is_active %}
                                                ë¹„í™œì„±í™”
                                            {% else %}
                                                í™œì„±í™”
                                            {% endif %}
                                        </button>
                                    </form>
                                    
                                    {% if not user.is_administrator() %}
                                        <button type="button" class="btn btn-danger" style="font-size: 0.8rem;" 
                                                id="delete-btn-{{ user.id }}"
                                                data-user-id="{{ user.id }}"
                                                data-username="{{ user.username }}">
                                            ì‚­ì œ
                                        </button>
                                    {% endif %}
                                {% else %}
                                    <span style="color: #6c757d; font-size: 0.8rem;">íƒˆí‡´ ì‚¬ìš©ì</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #6c757d; font-size: 0.8rem;">ìê¸° ìì‹ </span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        {% if search_query %}
            <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.</p>
        {% else %}
            <p>ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
    {% endif %}
</div>

<div class="card">
    <h3>ğŸ“Š ì‚¬ìš©ì í†µê³„</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #007bff;">{{ users|length }}</div>
            <p>ì „ì²´ ì‚¬ìš©ì</p>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #28a745;">{{ users|selectattr('is_active')|list|length }}</div>
            <p>í™œì„± ì‚¬ìš©ì</p>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #dc3545;">{{ users|selectattr('is_administrator')|list|length }}</div>
            <p>ê´€ë¦¬ì</p>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #ffc107;">{{ users|selectattr('is_verified')|list|length }}</div>
            <p>ì¸ì¦ëœ ì‚¬ìš©ì</p>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #dc3545;">{{ users|selectattr('is_withdrawn')|list|length }}</div>
            <p>íƒˆí‡´ ì‚¬ìš©ì</p>
        </div>
    </div>
</div>

<div class="card">
    <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary">â† ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
</div>

<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="deleteModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 5px; width: 400px;">
        <h3>âš ï¸ ê³„ì • ì‚­ì œ í™•ì¸</h3>
        <p id="deleteMessage">ì •ë§ë¡œ ì´ ì‚¬ìš©ìì˜ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <p style="color: #dc3545; font-weight: bold;">âš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!</p>
        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 20px;">
            <button onclick="closeDeleteModal()" class="btn btn-secondary">ì·¨ì†Œ</button>
            <form id="deleteForm" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-danger">ì‚­ì œ</button>
            </form>
        </div>
    </div>
</div>

<!-- ì™¸ë¶€ JavaScript íŒŒì¼ ì°¸ì¡° -->
<script src="{{ url_for('static', filename='js/user_delete.js') }}"></script>
{% endblock %} 