<!-- íŒŒì¼ëª…: user_home.html - ì¼ë°˜ ì‚¬ìš©ììš© ë©”ì¸ í˜ì´ì§€ -->
{% extends "base.html" %}
{% block content %}
<div class="card">
    <h1>ğŸ“ˆ ì£¼ì‹ ë¶„ì„ ì‹œìŠ¤í…œ</h1>
    <p>ê´€ì‹¬ ì¢…ëª©ì„ ë“±ë¡í•˜ê³  ì°¨íŠ¸ ë¶„ì„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
</div>

<h2>ê´€ì‹¬ ì¢…ëª© ë“±ë¡</h2>
<form id="ticker-form">
  <label for="ticker">ì¢…ëª© ì½”ë“œ:</label>
  <input type="text" id="ticker" required>
  <button type="submit">ì¡°íšŒ</button>
</form>

<div id="lookup-result" style="margin-top: 15px;"></div>

<h3 style="margin-top: 30px;">
  ğŸ“‹ í˜„ì¬ í™œì„± ì¢…ëª© ë¦¬ìŠ¤íŠ¸: <span id="current-list-name">Default</span>
</h3>

<div style="margin-bottom: 20px;">
  <label for="stock-list-select">ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì„ íƒ:</label>
  <select id="stock-list-select" onchange="selectStockList()">
  </select>
  {% if current_user.is_administrator() %}
    <button onclick="document.getElementById('create-list-modal').style.display='block'">ìƒˆ ë¦¬ìŠ¤íŠ¸ ìƒì„±</button>
  {% endif %}
  <button onclick="deleteStockList()">í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ì‚­ì œ</button>
</div>

<div id="create-list-modal" style="display:none; border: 1px solid #ccc; padding: 20px; margin-top: 20px; background-color: white;">
  <h4>ìƒˆ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ìƒì„±</h4>
  <label for="new-list-name">ë¦¬ìŠ¤íŠ¸ ì´ë¦„:</label>
  <input type="text" id="new-list-name" required>
  <button onclick="createStockList()">ìƒì„±</button>
  <button onclick="document.getElementById('create-list-modal').style.display='none'">ì·¨ì†Œ</button>
</div>

<!-- í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ìƒì„± -->
<div style="margin-top: 30px; margin-bottom: 20px; padding: 20px; background-color: #f8f9fa; border: 2px solid #007bff; border-radius: 10px;">
  <h3 style="margin-top: 0; color: #007bff;">ğŸ“Š í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ë¶„ì„</h3>
  
  <div style="margin-bottom: 20px; padding: 15px; background-color: white; border-radius: 8px; border-left: 4px solid #28a745;">
    <h4 style="margin-top: 0; color: #28a745;">ğŸ“Š í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ìƒì„±</h4>
    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
      <button id="batch-generate-btn" onclick="generateAllChartsAndAnalysis()" style="padding: 12px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer;">
        ğŸ“Š í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ì „ì²´ ì¢…ëª© ì¼ê´„ìƒì„±
      </button>
      <a href="/summary_page" target="_blank" style="padding: 12px 20px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; font-size: 16px; font-weight: bold;">
        ğŸ“ˆ í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ë¶„ì„ ìš”ì•½ ë³´ê¸°
      </a>
    </div>
    <div id="current-progress-text" style="margin-top: 10px; padding: 15px; background-color: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; display: none; font-size: 14px; color: #1976d2; font-weight: 500;">
      <!-- í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ì§„í–‰ìƒí™©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      <div style="margin-top: 10px;">
        <button id="stop-single-btn" onclick="stopBatchProcessing()" style="padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; display: none;">
          â¹ï¸ ì¼ê´„ìƒì„± ì¤‘ë‹¨
        </button>
      </div>
    </div>
  </div>
</div>

<h3>ğŸ“‹ ì¢…ëª© ëª©ë¡</h3>
<table id="ticker-table" border="1">
  <thead>
    <tr>
      <th><button onclick="sortTable(0)">í‹°ì»¤ â‡…</button></th>
      <th><button onclick="sortTable(1)">íšŒì‚¬ â‡…</button></th>
      <th>ì‚­ì œ</th>
      <th>ì°¨íŠ¸ ìƒì„±</th>
      <th>AI ë¶„ì„ ë³´ê¸°</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  let currentSortColumn = -1;
  let currentSortDirection = "asc"; // "asc" for ascending, "desc" for descending

  let progressInterval = null;

  // ì‹¤ì‹œê°„ ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  async function updateProgressDisplay() {
    try {
      console.log('ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ ì‹œì‘...');
      const response = await fetch('/get_current_progress');
      
      if (!response.ok) {
        console.warn('ì§„í–‰ìƒí™© ì¡°íšŒ ì‘ë‹µ ì‹¤íŒ¨:', response.status);
        return;
      }
      
      const data = await response.json();
      console.log('ì§„í–‰ìƒí™© ë°ì´í„°:', data); // ë””ë²„ê¹…ìš©
      
      const progressText = document.getElementById('current-progress-text');
      
      if (!progressText) {
        console.error('ì§„í–‰ìƒí™© í‘œì‹œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (data.is_running && data.type === 'single') {
        console.log('ì§„í–‰ ì¤‘ì¸ ë‹¨ì¼ ë¦¬ìŠ¤íŠ¸ ì‘ì—… ë°œê²¬');
        
        let displayText = '';
        displayText = `<strong>ğŸ“Š í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ìƒì„± ì§„í–‰ ì¤‘...</strong><br>`;
        displayText += `â€¢ í˜„ì¬ ì²˜ë¦¬ ì¤‘: <span style="color: #007bff; font-weight: bold;">${data.current_ticker || 'ì¤€ë¹„ ì¤‘'}</span><br>`;
        displayText += `â€¢ ì§„í–‰ë¥ : <span style="color: #28a745; font-weight: bold;">${data.processed_tickers}/${data.total_tickers} (${data.progress_percentage}%)</span><br>`;
        displayText += `â€¢ ë¦¬ìŠ¤íŠ¸: <span style="color: #6f42c1; font-weight: bold;">${data.current_list || 'ì•Œ ìˆ˜ ì—†ìŒ'}</span><br>`;
        if (data.elapsed_time) {
          displayText += `â€¢ ê²½ê³¼ ì‹œê°„: <span style="color: #6c757d;">${data.elapsed_time}</span><br>`;
        }
        if (data.estimated_completion) {
          displayText += `â€¢ ì˜ˆìƒ ì™„ë£Œ: <span style="color: #dc3545;">${data.estimated_completion}</span>`;
        }
        
        progressText.innerHTML = displayText + '<div style="margin-top: 10px;"><button id="stop-single-btn" onclick="stopBatchProcessing()" style="padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer;">â¹ï¸ ì¼ê´„ìƒì„± ì¤‘ë‹¨</button></div>';
        progressText.style.display = 'block';
        console.log('ë‹¨ì¼ ë¦¬ìŠ¤íŠ¸ ì§„í–‰ìƒí™© í‘œì‹œë¨');
        
        // ì§„í–‰ ì¤‘ì¼ ë•ŒëŠ” ëª¨ë‹ˆí„°ë§ ê³„ì† ìœ ì§€
        if (!progressInterval) {
          console.log('ì§„í–‰ ì¤‘ì¸ ì‘ì—… ë°œê²¬ - ëª¨ë‹ˆí„°ë§ ì¬ì‹œì‘');
          startProgressMonitoring();
        }
      } else if (data.is_running && data.type === 'multiple') {
        console.log('ì§„í–‰ ì¤‘ì¸ ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì‘ì—… ë°œê²¬');
        
        let displayText = '';
        displayText = `<strong>ğŸ¯ ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì¼ê´„ìƒì„± ì§„í–‰ ì¤‘...</strong><br>`;
        displayText += `â€¢ í˜„ì¬ ì²˜ë¦¬ ì¤‘: <span style="color: #007bff; font-weight: bold;">${data.current_ticker || 'ì¤€ë¹„ ì¤‘'}</span><br>`;
        displayText += `â€¢ ì§„í–‰ë¥ : <span style="color: #28a745; font-weight: bold;">${data.processed_tickers}/${data.total_tickers} (${data.progress_percentage}%)</span><br>`;
        displayText += `â€¢ ì²˜ë¦¬ ì¤‘ì¸ ë¦¬ìŠ¤íŠ¸: <span style="color: #6f42c1; font-weight: bold;">${data.current_list || 'ì•Œ ìˆ˜ ì—†ìŒ'}</span><br>`;
        if (data.elapsed_time) {
          displayText += `â€¢ ê²½ê³¼ ì‹œê°„: <span style="color: #6c757d;">${data.elapsed_time}</span><br>`;
        }
        if (data.estimated_completion) {
          displayText += `â€¢ ì˜ˆìƒ ì™„ë£Œ: <span style="color: #dc3545;">${data.estimated_completion}</span>`;
        }
        
        progressText.innerHTML = displayText + '<div style="margin-top: 10px;"><button id="stop-multiple-btn" onclick="stopBatchProcessing()" style="padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer;">â¹ï¸ ì¼ê´„ìƒì„± ì¤‘ë‹¨</button></div>';
        progressText.style.display = 'block';
        console.log('ì—¬ëŸ¬ ë¦¬ìŠ¤íŠ¸ ì§„í–‰ìƒí™© í‘œì‹œë¨');
        
        // ì§„í–‰ ì¤‘ì¼ ë•ŒëŠ” ëª¨ë‹ˆí„°ë§ ê³„ì† ìœ ì§€
        if (!progressInterval) {
          console.log('ì§„í–‰ ì¤‘ì¸ ì‘ì—… ë°œê²¬ - ëª¨ë‹ˆí„°ë§ ì¬ì‹œì‘');
          startProgressMonitoring();
        }
      } else {
        console.log('ì§„í–‰ ì¤‘ì¸ ì‘ì—… ì—†ìŒ - ì§„í–‰ìƒí™© í‘œì‹œ ìˆ¨ê¹€');
        // ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì´ ì—†ìœ¼ë©´ ì§„í–‰ìƒí™© í‘œì‹œ ìˆ¨ê¸°ê¸°
        progressText.style.display = 'none';
        
        // 3íšŒ ì—°ì† ì‘ì—… ì—†ìŒ í™•ì¸ í›„ ëª¨ë‹ˆí„°ë§ ì¤‘ë‹¨ (ë„ˆë¬´ ë¹¨ë¦¬ ì¤‘ë‹¨ë˜ëŠ” ê²ƒ ë°©ì§€)
        if (!window.noProgressCount) window.noProgressCount = 0;
        window.noProgressCount++;
        
        if (window.noProgressCount >= 3) {
          console.log('3íšŒ ì—°ì† ì§„í–‰ ì—†ìŒ í™•ì¸ - ëª¨ë‹ˆí„°ë§ ì¤‘ë‹¨');
          stopProgressMonitoring();
          window.noProgressCount = 0;
        }
      }
      
      // ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì´ ìˆìœ¼ë©´ ì¹´ìš´í„° ë¦¬ì…‹
      if (data.is_running) {
        window.noProgressCount = 0;
      }
      
    } catch (error) {
      console.error('ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
      // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì§„í–‰ìƒí™© í‘œì‹œ ì˜ì—­ì„ ìˆ¨ê¹€
      const progressText = document.getElementById('current-progress-text');
      if (progressText) progressText.style.display = 'none';
    }
  }

  // ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì‹œì‘
  function startProgressMonitoring() {
    console.log('ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì‹œì‘ ìš”ì²­ë¨');
    
    // ê¸°ì¡´ ì¸í„°ë²Œì´ ìˆìœ¼ë©´ ì •ë¦¬
    stopProgressMonitoring();
    
    // ìƒˆ ì¸í„°ë²Œ ì‹œì‘
    progressInterval = setInterval(updateProgressDisplay, 2000); // 2ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
    updateProgressDisplay(); // ì¦‰ì‹œ ì²« ë²ˆì§¸ ì—…ë°ì´íŠ¸
    
    console.log('ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì‹œì‘ë¨ - ì¸í„°ë²Œ ID:', progressInterval);
  }

  // ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì •ì§€
  function stopProgressMonitoring() {
    if (progressInterval) {
      console.log('ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì •ì§€ ìš”ì²­ë¨ - ì¸í„°ë²Œ ID:', progressInterval);
      clearInterval(progressInterval);
      progressInterval = null;
      console.log('ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì •ì§€ë¨');
    } else {
      console.log('ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ì´ ì´ë¯¸ ì •ì§€ëœ ìƒíƒœ');
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì‹œì‘
  document.addEventListener('DOMContentLoaded', function() {
    console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - ì§„í–‰ìƒí™© í™•ì¸ ì‹œì‘');
    // ì¦‰ì‹œ ì§„í–‰ìƒí™© í™•ì¸í•˜ì—¬ ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì´ ìˆìœ¼ë©´ ëª¨ë‹ˆí„°ë§ ì‹œì‘
    updateProgressDisplay().then(() => {
      // ì²« ë²ˆì§¸ í™•ì¸ í›„ ì •ê¸°ì ì¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘
      if (!progressInterval) {
        startProgressMonitoring();
      }
    });
  });

  async function loadStockLists() {
    try {
      const res = await fetch('/get_stock_lists');
      const lists = await res.json();
      const select = document.getElementById('stock-list-select');
      select.innerHTML = '';
      lists.forEach(listName => {
        const option = document.createElement('option');
        option.value = listName;
        option.textContent = listName;
        select.appendChild(option);
      });

      // Set current selected list
      const currentListRes = await fetch('/get_current_stock_list');
      const currentListData = await currentListRes.json();
      select.value = currentListData.current_list;
      document.getElementById('current-list-name').textContent = currentListData.current_list;

      loadTickers(); // Load tickers for the initially selected list
    } catch (error) {
      showInlineMessage("ì¢…ëª© ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì˜¤ë¥˜ ë°œìƒ: " + error.message, 'error');
      console.error("Load stock lists error:", error);
    }
  }

  async function selectStockList() {
    const select = document.getElementById('stock-list-select');
    const selectedListName = select.value;
    try {
      const res = await fetch('/select_stock_list', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ list_name: selectedListName })
      });
      const message = await res.text();
      showInlineMessage(message, res.ok ? 'success' : 'error');
      if (res.ok) {
        document.getElementById('current-list-name').textContent = selectedListName;
        loadTickers(); // Reload tickers for the newly selected list
      }
    } catch (error) {
      showInlineMessage("ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì„ íƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message, 'error');
      console.error("Select stock list error:", error);
    }
  }

  async function createStockList() {
    const newListName = document.getElementById('new-list-name').value.trim();
    if (!newListName) {
      showInlineMessage("ìƒˆ ë¦¬ìŠ¤íŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì‹­ì‹œì˜¤.", 'error');
      return;
    }

    try {
      const res = await fetch('/create_stock_list', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ list_name: newListName })
      });
      const message = await res.text();
      showInlineMessage(message, res.ok ? 'success' : 'error');
      if (res.ok) {
        document.getElementById('new-list-name').value = '';
        document.getElementById('create-list-modal').style.display = 'none';
        await loadStockLists(); // Reload lists to show the new one
        // The new list is automatically selected by the backend
      }
    } catch (error) {
      showInlineMessage("ìƒˆ ë¦¬ìŠ¤íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message, 'error');
      console.error("Create stock list error:", error);
    }
  }

  async function deleteStockList() {
    const select = document.getElementById('stock-list-select');
    const selectedListName = select.value;

    if (selectedListName === 'default') {
      showInlineMessage("ê¸°ë³¸ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'error');
      return;
    }

    if (!confirm(`ì •ë§ë¡œ '${selectedListName}' ì¢…ëª© ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ë¦¬ìŠ¤íŠ¸ì— í¬í•¨ëœ ëª¨ë“  ì¢…ëª©ì´ ì‚­ì œë©ë‹ˆë‹¤.`)) {
      return;
    }

    try {
      const res = await fetch(`/delete_stock_list?list_name=${selectedListName}`, {
        method: 'DELETE'
      });
      const message = await res.text();
      showInlineMessage(message, res.ok ? 'success' : 'error');
      if (res.ok) {
        await loadStockLists(); // Reload lists and update current list
      }
    } catch (error) {
      showInlineMessage("ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message, 'error');
      console.error("Delete stock list error:", error);
    }
  }

  async function loadTickers() {
    try {
        const res = await fetch('/get_tickers');
        const tickers = await res.json();
        const tbody = document.querySelector('#ticker-table tbody');
        tbody.innerHTML = '';

        if (tickers.error) {
            showInlineMessage(`âŒ ê´€ì‹¬ ì¢…ëª©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${tickers.error}`, 'error');
            return;
        }

        // Sort tickers before rendering if a sort was applied
        if (currentSortColumn !== -1) {
            tickers.sort((a, b) => {
                let valA, valB;
                if (currentSortColumn === 0) { // Ticker column
                    valA = a.ticker.toUpperCase();
                    valB = b.ticker.toUpperCase();
                } else if (currentSortColumn === 1) { // Company name column
                    valA = a.name.toUpperCase();
                    valB = b.name.toUpperCase();
                }

                if (valA < valB) return currentSortDirection === "asc" ? -1 : 1;
                if (valA > valB) return currentSortDirection === "asc" ? 1 : -1;
                return 0;
            });
        }

        tickers.forEach(row => {
          const ticker = row.ticker.toUpperCase();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${ticker}</td>
            <td>${row.name}</td>
            <td><button onclick="deleteTicker('${ticker}')">ì‚­ì œ</button></td>
            <td><button onclick="generateChart('${ticker}')">ì°¨íŠ¸ ìƒì„±</button></td>
            <td><button onclick="viewChartAnalysis('${ticker}')">ì°¨íŠ¸ ë¶„ì„ ë³´ê¸°</button></td>
          `;
          tbody.appendChild(tr);
        });
    } catch (error) {
        showInlineMessage(`âŒ ê´€ì‹¬ ì¢…ëª© ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
        console.error("Load tickers error:", error);
    }
  }

  function sortTable(column) {
    if (currentSortColumn === column) {
      // Same column, toggle direction
      currentSortDirection = currentSortDirection === "asc" ? "desc" : "asc";
    } else {
      // New column, set to ascending
      currentSortColumn = column;
      currentSortDirection = "asc";
    }
    loadTickers(); // Reload with new sort
  }

  console.log("âœ… JavaScript ë¡œë“œ ì™„ë£Œ - Form ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì¤€ë¹„");

  // Ticker form submission - index.htmlê³¼ ë™ì¼í•œ ì¡°íšŒâ†’ë“±ë¡ ë¡œì§
  document.getElementById('ticker-form').addEventListener('submit', async function(e) {
    console.log("ğŸ” Form submit ì´ë²¤íŠ¸ ë°œìƒ! JavaScript ì •ìƒ ì‘ë™ ì¤‘");
    e.preventDefault();
    console.log("ğŸ›‘ ê¸°ë³¸ form submit ë™ì‘ ì°¨ë‹¨ë¨");
    const ticker = document.getElementById('ticker').value.toUpperCase();
    console.log("ğŸ“Š ì¡°íšŒí•  ì¢…ëª©:", ticker);
    const lookupResultDiv = document.getElementById('lookup-result');
    lookupResultDiv.innerHTML = `<p>ì¡°íšŒ ì¤‘...</p>`;

    try {
        const res = await fetch(`/lookup?ticker=${ticker}`);
        if (!res.ok) {
            const errorText = await res.text();
            lookupResultDiv.innerHTML = `<p>ì¡°íšŒ ì‹¤íŒ¨: ${errorText}</p>`;
            return;
        }
        const data = await res.json();
        if (data.name) {
            lookupResultDiv.innerHTML = `
                <p>${data.name} (${ticker})</p>
                <button onclick="addTicker('${ticker}', '${data.name}')">ë“±ë¡</button>`;
        } else {
            lookupResultDiv.innerHTML = `<p>ì˜ëª»ëœ ì½”ë“œì´ê±°ë‚˜ ì¢…ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
        }
    } catch (error) {
        lookupResultDiv.innerHTML = `<p>ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`;
        console.error("Lookup error:", error);
    }
  });

  console.log("ğŸ¯ Form submit ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ!");

  // addTicker í•¨ìˆ˜ - index.htmlê³¼ ë™ì¼
  async function addTicker(ticker, name) {
    try {
        const res = await fetch('/add_ticker', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ticker, name })
        });
        
        // JSON ì‘ë‹µ ì²˜ë¦¬
        const data = await res.json();
        const message = data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì‘ë‹µ';
        
        showInlineMessage(message, data.success ? 'success' : 'error');
        
        if (data.success) {
            loadTickers();
            document.getElementById("lookup-result").innerHTML = '';
            document.getElementById("ticker").value = '';
        }
    } catch (error) {
        showInlineMessage("ì¢…ëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message, 'error');
        console.error("Add ticker error:", error);
    }
  }

  // deleteTicker í•¨ìˆ˜ - index.htmlê³¼ ë™ì¼
  async function deleteTicker(ticker) {
    if (!confirm(`ì •ë§ë¡œ ${ticker} ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    try {
        const res = await fetch(`/delete_ticker?ticker=${ticker}`, { method: 'DELETE' });
        
        // JSON ì‘ë‹µ ì²˜ë¦¬
        const data = await res.json();
        const message = data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì‘ë‹µ';
        
        showInlineMessage(message, data.success ? 'success' : 'error');
        
        if (data.success) {
            loadTickers();
        }
    } catch (error) {
        showInlineMessage("ì¢…ëª© ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message, 'error');
        console.error("Delete ticker error:", error);
    }
  }

  async function generateChart(ticker) {
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'ìƒì„± ì¤‘...';
    button.disabled = true;

    try {
      const res = await fetch(`/generate_chart/${ticker}`);
      if (res.ok) {
        const result = await res.json();
        showInlineMessage(`âœ… ${ticker} ì°¨íŠ¸ ìƒì„± ì™„ë£Œ!`, 'success');
      } else {
        const errorData = await res.json();
        showInlineMessage(`âŒ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨: ${errorData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
      }
    } catch (error) {
      showInlineMessage(`âŒ ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
      console.error("Generate chart error:", error);
    } finally {
      button.textContent = originalText;
      button.disabled = false;
    }
  }

  // ì¸ë¼ì¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
  function showInlineMessage(message, type) {
    // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
    const existingMessage = document.getElementById('inline-message');
    if (existingMessage) {
      existingMessage.remove();
    }

    // ìƒˆ ë©”ì‹œì§€ ìƒì„±
    const messageDiv = document.createElement('div');
    messageDiv.id = 'inline-message';
    messageDiv.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      max-width: 400px;
      word-wrap: break-word;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease-out;
    `;
    
    if (type === 'success') {
      messageDiv.style.backgroundColor = '#28a745';
    } else {
      messageDiv.style.backgroundColor = '#dc3545';
    }
    
    messageDiv.textContent = message;
    
    // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(messageDiv);
    
    // 3ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
      if (messageDiv.parentNode) {
        messageDiv.style.animation = 'slideOut 0.3s ease-in';
        messageDiv.style.transform = 'translateX(100%)';
        messageDiv.style.opacity = '0';
        setTimeout(() => {
          if (messageDiv.parentNode) {
            messageDiv.remove();
          }
        }, 300);
      }
    }, 3000);
  }

  async function viewChartAnalysis(ticker) {
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'ë¶„ì„ ì¤‘...';
    button.disabled = true;

    try {
      const res = await fetch('/view_chart_analysis', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ticker: ticker })
      });
      const result = await res.json();
      
      if (res.ok) {
        // ìƒˆ ì°½ì—ì„œ ì°¨íŠ¸ ë¶„ì„ ì—´ê¸°
        window.open(result.chart_url, '_blank');
        if (result.analysis_url) {
          setTimeout(() => window.open(result.analysis_url, '_blank'), 500);
        }
        showInlineMessage(`âœ… ${ticker} ì°¨íŠ¸ ë¶„ì„ì„ ìƒˆ ì°½ì—ì„œ ì—´ì—ˆìŠµë‹ˆë‹¤.`, 'success');
      } else {
        showInlineMessage(`âŒ ${result.error}`, 'error');
      }
    } catch (error) {
      showInlineMessage(`âŒ ì°¨íŠ¸ ë¶„ì„ ë³´ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
      console.error("View chart analysis error:", error);
    } finally {
      button.textContent = originalText;
      button.disabled = false;
    }
  }

  async function generateAllChartsAndAnalysis() {
    if (!confirm('í˜„ì¬ ë¦¬ìŠ¤íŠ¸ì˜ ëª¨ë“  ì¢…ëª©ì— ëŒ€í•´ ì°¨íŠ¸ì™€ ë¶„ì„ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
      return;
    }

    const button = document.getElementById('batch-generate-btn');
    const originalText = button.textContent;
    button.textContent = 'ì²˜ë¦¬ ì¤‘...';
    button.disabled = true;

    try {
      // í˜„ì¬ ë¦¬ìŠ¤íŠ¸ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
      const currentListName = document.getElementById('current-list-name').textContent;
      const res = await fetch(`/generate_all_charts_and_analysis/${currentListName}`, {
        method: 'POST'
      });
      const result = await res.json();
      
      if (res.ok) {
        showInlineMessage(`âœ… ${result.message}`, 'success');
        // Start monitoring progress
        startProgressMonitoring();
      } else {
        showInlineMessage(`âŒ ${result.error}`, 'error');
      }
    } catch (error) {
      showInlineMessage(`âŒ ì¼ê´„ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
      console.error("Generate all charts and analysis error:", error);
    } finally {
      button.textContent = originalText;
      button.disabled = false;
    }
  }

  async function stopBatchProcessing() {
    if (!confirm('ì§„í–‰ ì¤‘ì¸ ì¼ê´„ ìƒì„± ì‘ì—…ì„ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }

    const button = document.getElementById('stop-single-btn');
    const originalText = button.textContent;
    button.textContent = 'ì¤‘ë‹¨ ì¤‘...';
    button.disabled = true;

    try {
      const res = await fetch('/stop_batch_processing', {
        method: 'POST'
      });
      const result = await res.json();
      
      if (res.ok) {
        showInlineMessage(`âœ… ${result.message}`, 'success');
        // Stop monitoring progress
        stopProgressMonitoring();
        const progressText = document.getElementById('current-progress-text');
        if (progressText) progressText.style.display = 'none';
      } else {
        showInlineMessage(`âŒ ${result.error}`, 'error');
      }
    } catch (error) {
      showInlineMessage(`âŒ ì‘ì—… ì¤‘ë‹¨ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
      console.error("Stop batch processing error:", error);
    } finally {
      button.textContent = originalText;
      button.disabled = false;
    }
  }

  // Load stock lists and tickers when page loads
  loadStockLists();
</script>
{% endblock %} 