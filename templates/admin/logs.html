{% extends "base.html" %}

{% block title %}ë¡œê·¸ ê´€ë¦¬{% endblock %}

{% block content %}
<div class="card">
    <h1>ğŸ“‹ ë¡œê·¸ ê´€ë¦¬</h1>
    <p>ì‹œìŠ¤í…œ ë¡œê·¸ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
</div>

<div style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem;">
    <!-- ì¢Œì¸¡: ë¡œê·¸ íŒŒì¼ ëª©ë¡ -->
    <div class="card">
        <h3>ğŸ“ ë¡œê·¸ íŒŒì¼ ëª©ë¡</h3>
        <div id="log-files-list">
            {% for file in log_files %}
            <div class="log-file-item" data-file-path="{{ file.path }}">
                <div style="font-weight: bold;">{{ file.name }}</div>
                <div style="font-size: 0.9em; color: #666;">
                    {{ file.size_mb }}MB | {{ file.modified_str }}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div style="margin-top: 1rem;">
            <button id="btn-start-stream" class="btn btn-primary">ğŸš€ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘</button>
            <button id="btn-stop-stream" class="btn btn-secondary" style="display: none;">â¹ï¸ ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì§€</button>
        </div>
        
        <div style="margin-top: 1rem;">
            <label>
                <input type="checkbox" id="auto-scroll" checked> ìë™ ìŠ¤í¬ë¡¤
            </label>
        </div>
    </div>
    
    <!-- ìš°ì¸¡: í„°ë¯¸ë„ ìŠ¤íƒ€ì¼ ë¡œê·¸ í‘œì‹œ -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3>ğŸ–¥ï¸ ì‹¤ì‹œê°„ ë¡œê·¸</h3>
            <div>
                <button id="btn-clear-log" class="btn btn-warning">ğŸ—‘ï¸ í™”ë©´ ì§€ìš°ê¸°</button>
                <span id="connection-status" style="margin-left: 1rem; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.9em;">
                    ì—°ê²° ëŒ€ê¸°
                </span>
            </div>
        </div>
        
        <div id="log-terminal" style="
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 1rem;
            height: 600px;
            overflow-y: auto;
            border: 2px solid #333;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
        ">
            <div style="color: #888;">ë¡œê·¸ íŒŒì¼ì„ ì„ íƒí•˜ê³  ìŠ¤íŠ¸ë¦¬ë°ì„ ì‹œì‘í•˜ì„¸ìš”...</div>
        </div>
        
        <div style="margin-top: 1rem; font-size: 0.9em; color: #666;">
            <strong>í˜„ì¬ íŒŒì¼:</strong> <span id="current-file">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
        </div>
    </div>
</div>

<style>
.log-file-item {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.log-file-item:hover {
    background-color: #f5f5f5;
}

.log-file-item.selected {
    background-color: #007bff;
    color: white;
}

.log-file-item.selected:hover {
    background-color: #0056b3;
}

#connection-status.connected {
    background-color: #28a745;
    color: white;
}

#connection-status.disconnected {
    background-color: #dc3545;
    color: white;
}

#connection-status.connecting {
    background-color: #ffc107;
    color: black;
}

.log-line {
    margin: 0.25rem 0;
    padding: 0.1rem 0;
}

.log-line.error {
    color: #ff6b6b;
}

.log-line.warning {
    color: #ffd43b;
}

.log-line.info {
    color: #74c0fc;
}

.log-line.success {
    color: #51cf66;
}
</style>

<script>
let eventSource = null;
let currentFile = null;
let autoScroll = true;
let logLineCount = 0;
const maxLines = 1000;

document.addEventListener('DOMContentLoaded', function() {
    const logFileItems = document.querySelectorAll('.log-file-item');
    const startBtn = document.getElementById('btn-start-stream');
    const stopBtn = document.getElementById('btn-stop-stream');
    const clearBtn = document.getElementById('btn-clear-log');
    const autoScrollCheckbox = document.getElementById('auto-scroll');
    const terminal = document.getElementById('log-terminal');
    const currentFileSpan = document.getElementById('current-file');
    const connectionStatus = document.getElementById('connection-status');

    // ë¡œê·¸ íŒŒì¼ ì„ íƒ
    logFileItems.forEach(item => {
        item.addEventListener('click', function() {
            logFileItems.forEach(i => i.classList.remove('selected'));
            this.classList.add('selected');
            currentFile = this.dataset.filePath;
            currentFileSpan.textContent = this.querySelector('div').textContent;
        });
    });

    // ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘
    startBtn.addEventListener('click', function() {
        if (!currentFile) {
            alert('ë¡œê·¸ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        startStreaming();
    });

    // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì§€
    stopBtn.addEventListener('click', function() {
        stopStreaming();
    });

    // í™”ë©´ ì§€ìš°ê¸°
    clearBtn.addEventListener('click', function() {
        terminal.innerHTML = '<div style="color: #888;">ë¡œê·¸ í™”ë©´ì´ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤...</div>';
        logLineCount = 0;
    });

    // ìë™ ìŠ¤í¬ë¡¤ í† ê¸€
    autoScrollCheckbox.addEventListener('change', function() {
        autoScroll = this.checked;
    });

    function startStreaming() {
        if (eventSource) {
            eventSource.close();
        }

        updateConnectionStatus('connecting', 'ì—°ê²° ì¤‘...');
        
        eventSource = new EventSource(`/admin/logs/stream?file=${encodeURIComponent(currentFile)}`);
        
        eventSource.onopen = function() {
            updateConnectionStatus('connected', 'ì—°ê²°ë¨');
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
        };

        eventSource.onmessage = function(event) {
            const logLine = event.data;
            if (logLine.trim()) {
                addLogLine(logLine);
            }
        };

        eventSource.onerror = function(event) {
            updateConnectionStatus('disconnected', 'ì—°ê²° ì˜¤ë¥˜');
            console.error('EventSource error:', event);
        };
    }

    function stopStreaming() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
        
        updateConnectionStatus('disconnected', 'ì—°ê²° ì¤‘ì§€');
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
    }

    function addLogLine(line) {
        const logDiv = document.createElement('div');
        logDiv.className = 'log-line';
        
        // ë¡œê·¸ ë ˆë²¨ì— ë”°ë¥¸ ìƒ‰ìƒ ì ìš©
        if (line.includes('ERROR') || line.includes('ì˜¤ë¥˜')) {
            logDiv.classList.add('error');
        } else if (line.includes('WARNING') || line.includes('ê²½ê³ ')) {
            logDiv.classList.add('warning');
        } else if (line.includes('INFO') || line.includes('ì •ë³´')) {
            logDiv.classList.add('info');
        } else if (line.includes('successful') || line.includes('ì„±ê³µ')) {
            logDiv.classList.add('success');
        }
        
        // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
        const timestamp = new Date().toLocaleTimeString();
        logDiv.textContent = `[${timestamp}] ${line}`;
        
        terminal.appendChild(logDiv);
        logLineCount++;
        
        // ìµœëŒ€ ë¼ì¸ ìˆ˜ ì œí•œ
        if (logLineCount > maxLines) {
            terminal.removeChild(terminal.firstChild);
            logLineCount--;
        }
        
        // ìë™ ìŠ¤í¬ë¡¤
        if (autoScroll) {
            terminal.scrollTop = terminal.scrollHeight;
        }
    }

    function updateConnectionStatus(status, text) {
        connectionStatus.className = status;
        connectionStatus.textContent = text;
    }

    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° ì •ë¦¬
    window.addEventListener('beforeunload', function() {
        if (eventSource) {
            eventSource.close();
        }
    });
});
</script>
{% endblock %} 